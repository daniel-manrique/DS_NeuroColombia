[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "NeuroColombia Data Analysis",
    "section": "",
    "text": "Introduction\nWelcome to the NeuroColombia Data Analysis project. This book documents the complete data analysis pipeline for investigating neurodevelopmental disorder consultations in Colombia from 2016 to 2022.",
    "crumbs": [
      "Introduction"
    ]
  },
  {
    "objectID": "index.html#project-overview",
    "href": "index.html#project-overview",
    "title": "NeuroColombia Data Analysis",
    "section": "Project Overview",
    "text": "Project Overview\nThe goal of this project is to analyze the frequency and distribution of neurodevelopmental diagnoses using public health data from the Colombian Ministry of Health and population projections from DANE.\nThis book is organized into the following chapters:\n\nData Cleaning and Processing: Details the procedures for cleaning raw data, standardizing text, and merging diagnostic records with population data.\nConsultation Frequency Analysis: Explores temporal trends and geographical distributions of consultations at a general level.\nDiagnostic Frequency Analysis: Breaks down consultations by specific ICD-10 diagnostic categories to identify the most prevalent conditions.\nDeep Dive: Top 3 Diagnostics: A focused analysis of the three most frequent diagnoses (F900, F809, F808), examining their distribution by sex, age, and geography.",
    "crumbs": [
      "Introduction"
    ]
  },
  {
    "objectID": "index.html#data-sources",
    "href": "index.html#data-sources",
    "title": "NeuroColombia Data Analysis",
    "section": "Data Sources",
    "text": "Data Sources\n\nMinistry of Health: Raw consultation records (SISPRO).\nDANE: Official population projections for Colombia.",
    "crumbs": [
      "Introduction"
    ]
  },
  {
    "objectID": "index.html#reproducibility",
    "href": "index.html#reproducibility",
    "title": "NeuroColombia Data Analysis",
    "section": "Reproducibility",
    "text": "Reproducibility\nAll code used in this analysis is available in the GitHub repository. The analysis is written in R and rendered using Quarto.",
    "crumbs": [
      "Introduction"
    ]
  },
  {
    "objectID": "0_NeuroColombia_DataCleaning.html",
    "href": "0_NeuroColombia_DataCleaning.html",
    "title": "1  Data Cleaning and Processing",
    "section": "",
    "text": "1.1 Install and Load Packages\nWe begin by installing and loading the necessary R packages for data manipulation and processing. These packages provide the tools required for reading Excel files, manipulating strings, and performing efficient data frame operations.\nCode\nif (!requireNamespace(\"dplyr\", quietly = TRUE)) install.packages(\"dplyr\")\nif (!requireNamespace(\"gt\", quietly = TRUE)) install.packages(\"gt\")\nif (!requireNamespace(\"purrr\", quietly = TRUE)) install.packages(\"purrr\")\nif (!requireNamespace(\"readxl\", quietly = TRUE)) install.packages(\"readxl\")\nif (!requireNamespace(\"stringr\", quietly = TRUE)) install.packages(\"stringr\")\nif (!requireNamespace(\"stringi\", quietly = TRUE)) install.packages(\"stringi\")\nif (!requireNamespace(\"tidyr\", quietly = TRUE)) install.packages(\"tidyr\")\n\nlibrary(dplyr)\n\n\n\nAttaching package: 'dplyr'\n\n\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n\n\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n\n\nCode\nlibrary(gt)\nlibrary(purrr)\nlibrary(readxl)\n\n\nWarning: package 'readxl' was built under R version 4.4.2\n\n\nCode\nlibrary(stringr)\nlibrary(stringi)\nlibrary(tidyr)",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Data Cleaning and Processing</span>"
    ]
  },
  {
    "objectID": "0_NeuroColombia_DataCleaning.html#handling-of-neurodevelopmental-data",
    "href": "0_NeuroColombia_DataCleaning.html#handling-of-neurodevelopmental-data",
    "title": "1  Data Cleaning and Processing",
    "section": "1.2 Handling of Neurodevelopmental Data",
    "text": "1.2 Handling of Neurodevelopmental Data\nThis section details the processing of raw neurodevelopmental consultation data obtained from the Colombian Ministry of Health. Our objective is to transform the raw Excel sheets into a structured, standardized dataset suitable for analysis.\n\n1.2.1 Load Data\nThe raw data is stored in a single Excel file (Ministry_OriginalData.xlsx) containing multiple sheets. We use readxl::excel_sheets() to retrieve all sheet names and then apply purrr::map_dfr() to iteratively read each sheet and combine them into a single data frame, Ministry_data_Raw.\n\n\nCode\n# Define the file path \nfile_path &lt;- \"Data_Raw/Ministry_OriginalData.xlsx\"\n\n# Get all sheet names\nsheet_names &lt;- excel_sheets(file_path)\n\n# Read all sheets and combine them\nMinistry_data_Raw &lt;- map_dfr(sheet_names, ~ read_excel(file_path, sheet = .x), .id = \"SheetName\")\n\n\nWe display the first 10 rows to inspect the raw structure of the dataset.\n\n\nCode\ngt::gt(Ministry_data_Raw[1:10,])\n\n\n\n\n\n\n\n\nSheetName\nAño\nDepartamento\nMunicipio\nDiagnósticos\nEdad\nSexo\nPersonas Atendidas\n\n\n\n\n1\n2016\n05 - Antioquia\n05001 - Medellín\nF700 - RETRASO MENTAL LEVE: DETERIORO DEL COMPORTAMIENTO NULO O MINIMO\nDe 02 años\nMASCULINO\n1\n\n\n1\n2016\n05 - Antioquia\n05001 - Medellín\nF700 - RETRASO MENTAL LEVE: DETERIORO DEL COMPORTAMIENTO NULO O MINIMO\nDe 04 años\nFEMENINO\n2\n\n\n1\n2016\n05 - Antioquia\n05001 - Medellín\nF700 - RETRASO MENTAL LEVE: DETERIORO DEL COMPORTAMIENTO NULO O MINIMO\nDe 04 años\nMASCULINO\n1\n\n\n1\n2016\n05 - Antioquia\n05001 - Medellín\nF700 - RETRASO MENTAL LEVE: DETERIORO DEL COMPORTAMIENTO NULO O MINIMO\nDe 06 años\nFEMENINO\n1\n\n\n1\n2016\n05 - Antioquia\n05001 - Medellín\nF700 - RETRASO MENTAL LEVE: DETERIORO DEL COMPORTAMIENTO NULO O MINIMO\nDe 06 años\nMASCULINO\n1\n\n\n1\n2016\n05 - Antioquia\n05001 - Medellín\nF700 - RETRASO MENTAL LEVE: DETERIORO DEL COMPORTAMIENTO NULO O MINIMO\nDe 06 años\nNR - NO REPORTADO\n1\n\n\n1\n2016\n05 - Antioquia\n05001 - Medellín\nF700 - RETRASO MENTAL LEVE: DETERIORO DEL COMPORTAMIENTO NULO O MINIMO\nDe 07 años\nFEMENINO\n3\n\n\n1\n2016\n05 - Antioquia\n05001 - Medellín\nF700 - RETRASO MENTAL LEVE: DETERIORO DEL COMPORTAMIENTO NULO O MINIMO\nDe 07 años\nMASCULINO\n8\n\n\n1\n2016\n05 - Antioquia\n05001 - Medellín\nF700 - RETRASO MENTAL LEVE: DETERIORO DEL COMPORTAMIENTO NULO O MINIMO\nDe 08 años\nFEMENINO\n5\n\n\n1\n2016\n05 - Antioquia\n05001 - Medellín\nF700 - RETRASO MENTAL LEVE: DETERIORO DEL COMPORTAMIENTO NULO O MINIMO\nDe 08 años\nMASCULINO\n6\n\n\n\n\n\n\n\n\n\n1.2.2 Clean and Standardize Ministry Data\nUpon visual inspection, we identify several inconsistencies that require cleaning. We perform the following steps to standardize the data.\n\n1.2.2.1 Rename Columns\nFirst, we rename the columns from Spanish to English to ensure clarity and consistency throughout the analysis. We also remove the SheetName column as it is no longer needed.\n\n\nCode\n# Eliminate the first column\nMinistry_data_Raw &lt;- Ministry_data_Raw %&gt;% select(-SheetName)\n\n# Change column names in order\ncolnames(Ministry_data_Raw) &lt;- c(\"Year\", \"Department\",  \"City\", \"Diagnostic\", \"Age\", \"Sex\", \"Cases\")\n\n\n\n\n1.2.2.2 Clean Data Values\nNext, we clean the values within the columns using string manipulation and recoding techniques:\n\nDepartment/City: We remove numerical prefixes (e.g., “05 - Antioquia”) and convert the text to Title Case.\nDiagnostic: We extract only the ICD-10 code (e.g., “F900”), discarding the descriptive text.\nAge: We extract only the numeric age value.\nSex: We recode the values from Spanish (“MASCULINO”, “FEMENINO”) to English (“Men”, “Women”).\n\n\n\nCode\nMinistry_data_clean &lt;- Ministry_data_Raw %&gt;%\n  # Remove numbers and hyphen from 'Department' column\n  mutate(Department = str_remove(Department, \"^\\\\d+\\\\s-\\\\s*\"),\n         Department = str_to_title(Department)) %&gt;%  # Convert to Title Case\n  \n  # Remove numbers and hyphen from 'City' column\n  mutate(City = str_remove(City, \"^\\\\d+\\\\s-\\\\s*\"),\n         City = str_to_title(City)) %&gt;%  # Convert to Title Case\n  \n  # Extract only the diagnostic code starting with \"F\"\n  mutate(Diagnostic = str_extract(Diagnostic, \"^F\\\\d+\")) %&gt;%\n  \n  # Extract only numeric values from 'Age' column\n  mutate(Age = str_extract(Age, \"\\\\d+\")) %&gt;%\n  \n  # Replace \"MASCULINO\" with \"Men\" and \"FEMENINO\" with \"Women\"\n  mutate(Sex = recode(Sex, \"MASCULINO\" = \"Men\", \"FEMENINO\" = \"Women\"))\n\n\n\n\n1.2.2.3 Standardize Text (Unicode and Capitalization)\nTo ensure accurate joins with other datasets (such as population data), we must standardize all text fields.\n\nAccents: We use stringi::stri_trans_general() to remove all Spanish accents (e.g., “Bogotá” becomes “Bogota”).\nCapitalization: We standardize common articles (e.g., “De”, “Del”) to lowercase (“de”, “del”) and ensure “D.C.” is correctly formatted for Bogotá.\n\n\n\nCode\n# Remove accents\nMinistry_data_clean &lt;- Ministry_data_clean %&gt;%\n  mutate(\n    Department = stri_trans_general(Department, \"Latin-ASCII\"),\n    City = stri_trans_general(City, \"Latin-ASCII\")\n  )\n\n# Fix capitalization and \"D.C.\"\nMinistry_data_clean &lt;- Ministry_data_clean %&gt;%\n  mutate(City = str_replace_all(City, \"\\\\bDe\\\\b\", \"de\"),\n         City = str_replace_all(City, \"\\\\bDel\\\\b\", \"del\"),\n         City = str_replace_all(City, \"\\\\bLa\\\\b\", \"la\"),\n         Department = str_replace_all(Department, \"\\\\bDe\\\\b\", \"de\"),\n         Department = str_replace_all(Department, \"\\\\bDel\\\\b\", \"del\"),\n         Department = str_replace(Department, \"\\\\bD.c\\\\b\", \"D.C\"),\n         City = str_replace(City, \"\\\\bD.c\\\\b\", \"D.C\"),\n         City = str_replace(City, \"Bogota\", \"Bogota, D.C\"))\n\n# Fix potential duplicates created by the replace (e.g., \"Bogota, D.C, D.C.\")\nMinistry_data_clean &lt;- Ministry_data_clean %&gt;%\n  mutate(\n    City = case_when(\n      City == \"Bogota, D.C, D.C.\" ~ \"Bogota, D.C.\", TRUE ~ City ))\n\n\nWe verify the cleaned table structure:\n\n\nCode\ngt::gt(Ministry_data_clean[1:10,])\n\n\n\n\n\n\n\n\nYear\nDepartment\nCity\nDiagnostic\nAge\nSex\nCases\n\n\n\n\n2016\nAntioquia\nMedellin\nF700\n02\nMen\n1\n\n\n2016\nAntioquia\nMedellin\nF700\n04\nWomen\n2\n\n\n2016\nAntioquia\nMedellin\nF700\n04\nMen\n1\n\n\n2016\nAntioquia\nMedellin\nF700\n06\nWomen\n1\n\n\n2016\nAntioquia\nMedellin\nF700\n06\nMen\n1\n\n\n2016\nAntioquia\nMedellin\nF700\n06\nNR - NO REPORTADO\n1\n\n\n2016\nAntioquia\nMedellin\nF700\n07\nWomen\n3\n\n\n2016\nAntioquia\nMedellin\nF700\n07\nMen\n8\n\n\n2016\nAntioquia\nMedellin\nF700\n08\nWomen\n5\n\n\n2016\nAntioquia\nMedellin\nF700\n08\nMen\n6\n\n\n\n\n\n\n\n\n\n\n1.2.3 Subset Ministry Data\nWe filter the dataset based on the study’s specific inclusion criteria:\n\nSex: We include only “Men” and “Women” (excluding “NO REPORTADO”).\nAge: We include children aged 0 to 11 years, inclusive.\nLocation: We exclude entries where Department or City is “No Definido” (Not defined).\nData Types: We ensure that Year and Age columns are numeric.\n\n\n\nCode\nMinistery_DiagnosticData &lt;- Ministry_data_clean %&gt;%\n  filter(Sex %in% c(\"Men\", \"Women\"),\n         as.numeric(Age) &gt;= 0 & as.numeric(Age) &lt;= 11,\n         !Department %in% c(\"No Definido\", \"-1 - No Definido\"),\n         !City %in% c(\"No Definido\", \"-1 - No Definido\"))\n\n# Make sure year and age are numerical\nMinistery_DiagnosticData$Year &lt;- as.numeric(Ministery_DiagnosticData$Year)\nMinistery_DiagnosticData$Age &lt;- as.numeric(Ministery_DiagnosticData$Age)\n\n\nThe resulting table contains 382,008 diagnostic cases. We display the structure of the dataset to verify its attributes:\n\n\nCode\n# Display the subsetted dataset\nstr(Ministery_DiagnosticData)\n\n\ntibble [382,008 × 7] (S3: tbl_df/tbl/data.frame)\n $ Year      : num [1:382008] 2016 2016 2016 2016 2016 ...\n $ Department: chr [1:382008] \"Antioquia\" \"Antioquia\" \"Antioquia\" \"Antioquia\" ...\n $ City      : chr [1:382008] \"Medellin\" \"Medellin\" \"Medellin\" \"Medellin\" ...\n $ Diagnostic: chr [1:382008] \"F700\" \"F700\" \"F700\" \"F700\" ...\n $ Age       : num [1:382008] 2 4 4 6 6 7 7 8 8 9 ...\n $ Sex       : chr [1:382008] \"Men\" \"Women\" \"Men\" \"Women\" ...\n $ Cases     : num [1:382008] 1 2 1 1 1 3 8 5 6 8 ...\n\n\nThe table contains the following variables:\n\nYear: Year in which the neurological diagnosis was made (2016–2022).\nDepartment: Geographical Colombian department where the diagnosis was made.\nCity: City where the diagnosis was made.\nDiagnosis: Neurodevelopmental diagnosis according to ICD-10.\nAge: Age of the diagnosed person.\nSex: Biological sex/gender of the diagnosed person (Men or Women).\nCases: Number of diagnosed cases.\n\nWe save this intermediate cleaned file. This table contains only the case data, without population denominators. The cleaned data is used in the subsequent analyses: Consultation Frequency Analysis.\n\n\nCode\nwrite.csv(Ministery_DiagnosticData, \"Data_Processed/Ministery_DiagnosticData.csv\", row.names = FALSE, fileEncoding = \"UTF-8\")\n\n\n\n\n\n\n\n\nWarning\n\n\n\nPlease note that as this file contains special Spanish characters, if opened in Excel, the user needs to ensure the correct encoding:\n\nOpen Excel → Go to Data → Get External Data → From Text.\nChoose the .csv file and set UTF-8 encoding in the import wizard.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Data Cleaning and Processing</span>"
    ]
  },
  {
    "objectID": "0_NeuroColombia_DataCleaning.html#handling-of-dane-population-data",
    "href": "0_NeuroColombia_DataCleaning.html#handling-of-dane-population-data",
    "title": "1  Data Cleaning and Processing",
    "section": "1.3 Handling of DANE Population Data",
    "text": "1.3 Handling of DANE Population Data\nIn this section, we load, clean, and reshape the population data from DANE (National Administrative Department of Statistics) to serve as the denominator for calculating consultation rates.\n\n1.3.1 Load and Subset DANE Data\nWe load two separate Excel files containing population projections (2005-2019 and 2020-2035) and merge them using rbind().\n\n\nCode\nDane_Data_2019 &lt;- read_excel(\"Data_Raw/DANE_PopulationData_2005-2019.xlsx\") \nDane_Data_2035 &lt;- read_excel(\"Data_Raw/DANE_PopulationData_2020-2035.xlsx\")\n\n# We merge the datasets\nDane_Data_Total &lt;- rbind(Dane_Data_2019, Dane_Data_2035)\n\n\nWe then subset this large dataset to match our study criteria:\n\nÁREA GEOGRÁFICA: “Total” (to include both urban and rural populations).\nAÑO: 2016 to 2022.\nDPNOM / DPMP: Exclude “No Definido”.\nColumns: We select only the ID columns (DPNOM, DPMP, AÑO) and the population columns for men and women aged 0-11 (e.g., “Hombres_0”…“Mujeres_11”).\n\n\n\nCode\n# We select the rows containing total counts\nDane_Data_Total &lt;- subset(Dane_Data_Total, `ÁREA GEOGRÁFICA` == \"Total\")\n\n# We subset ID variables and population columns\nDane_Data_Total &lt;- Dane_Data_Total %&gt;%\n  filter(AÑO &gt;= 2016 & AÑO &lt;= 2022,\n         DPNOM != \"No Definido\",\n         DPMP != \"No Definido\") %&gt;%\n  select(DPNOM, DPMP, AÑO, matches(\"^(Hombres|Mujeres)_([0-9]|1[0-1])$\"))\n\n\nThe resulting table provides information on the number of men (Hombres) and women (Mujeres) from 0 to 11 years of age by year, department, and city in Colombia.\n\n\n1.3.2 Standardize DANE Text\nAs with the Ministry data, we standardize all text (remove accents, normalize capitalization) to prepare for merging.\n\n\nCode\nDane_Data_Total &lt;- Dane_Data_Total %&gt;%\n  mutate(\n    DPNOM = stri_trans_general(DPNOM, \"Latin-ASCII\"),\n    DPMP = stri_trans_general(DPMP, \"Latin-ASCII\")\n  )\n\nDane_Data_Total &lt;- Dane_Data_Total %&gt;%\n  mutate(DPMP = str_replace_all(DPMP, \"\\\\bDe\\\\b\", \"de\"),\n         DPMP = str_replace_all(DPMP, \"\\\\bDel\\\\b\", \"del\"),\n         DPMP = str_replace_all(DPMP, \"\\\\bLa\\\\b\", \"la\"),\n         DPNOM = str_replace_all(DPNOM, \"\\\\bDe\\\\b\", \"de\"),\n         DPNOM = str_replace_all(DPNOM, \"\\\\bDel\\\\b\", \"del\"))\n\n\n\n\n1.3.3 Reshape DANE Data (Wide to Long)\nThe DANE data is initially in a “wide” format (one column for each age-sex group). We use tidyr::pivot_longer() to reshape it into a “long” format. This creates one row per city-year-sex-age combination, with columns Sexo, Edad, and Poblacion.\n\n\nCode\nDane_Data_Total_long &lt;- Dane_Data_Total %&gt;%\n  pivot_longer(\n    cols = c(starts_with(\"Hombres_\"), starts_with(\"Mujeres_\")),\n    names_to = c(\"Sexo\", \"Edad\"),\n    names_sep = \"_\",\n    values_to = \"Poblacion\"\n  )\n\nDane_Data_Total_long$Edad &lt;- as.numeric(Dane_Data_Total_long$Edad)\n\n\n\n\n1.3.4 Standardize DANE Columns\nFinally, we rename the DANE columns (DPNOM -&gt; Department, etc.) and recode Sex (“Hombres” -&gt; “Men”) to exactly match the Ministery_DiagnosticData table.\n\n\nCode\n# Change column names in order\ncolnames(Dane_Data_Total_long) &lt;- c(\"Department\", \"City\",  \"Year\", \"Sex\", \"Age\", \"Population\")\n\n# Replace \"Hombres\" with \"Men\" and \"Mujeres\" with \"Women\"\nDane_Data_Total_long &lt;- Dane_Data_Total_long %&gt;%\n  mutate(Sex = recode(Sex, \"Hombres\" = \"Men\", \"Mujeres\" = \"Women\"))",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Data Cleaning and Processing</span>"
    ]
  },
  {
    "objectID": "0_NeuroColombia_DataCleaning.html#relate-diagnostic-and-population-data",
    "href": "0_NeuroColombia_DataCleaning.html#relate-diagnostic-and-population-data",
    "title": "1  Data Cleaning and Processing",
    "section": "1.4 Relate Diagnostic and Population Data",
    "text": "1.4 Relate Diagnostic and Population Data\n\n1.4.1 Handle Join Mismatches\nOur goal is to join the Ministery_DiagnosticData with Dane_Data_Total_long. However, preliminary checks revealed NAs, indicating naming convention mismatches between the two datasets (e.g., “Cartagena de Indias” vs. “Cartagena”).\nTo resolve this, we manually recode the city/department names in the Dane_Data_Total_long dataset to match the names used in the Ministery_DiagnosticData dataset.\n\n\nCode\nDane_Data_Total_long &lt;- Dane_Data_Total_long %&gt;%\n  mutate(\n    City = case_when(\n      City == \"Cartagena de Indias\" ~ \"Cartagena\",\n      City == \"San Jose de Cucuta\" ~ \"Cucuta\",\n      City == \"Piendamo - Tunia\" ~ \"Piendamo\",\n      City == \"Archipielago de San Andres\" ~ \"Archipielago de San Andres, Providencia Y Santa Catalina\",\n      City == \"Cuaspud Carlosama\" ~ \"Cuaspud\",\n      City == \"Donmatias\" ~ \"Don Matias\",\n      City == \"Purisima de La Concepcion\" ~ \"Purisima\",\n      City == \"Sotara Paispamba\" ~ \"Sotara\",\n      City == \"Manaure Balcon del Cesar\" ~ \"Manaure\",\n      City == \"Puerto Leguizamo\" ~ \"Leguizamo\",\n      City == \"Cacahual (ANM)\" ~ \"Cacahual\",\n      City == \"Guican de La Sierra\" ~ \"Guican\",\n      City == \"Lopez de Micay\" ~ \"Lopez\",\n      City == \"El Encanto (ANM)\" ~ \"El Encanto\",\n      City == \"La Chorrera (ANM)\" ~ \"La Chorrera\",\n      City == \"Tarapaca (ANM)\" ~ \"Tarapaca\",\n      City == \"Barrancominas (ANM)\" ~ \"Barrancominas\",\n      City == \"La Pedrera (ANM)\" ~ \"La Pedrera\",\n      City == \"Puerto Santander (ANM)\" ~ \"Puerto Santander\",\n      City == \"Puerto Colombia (ANM)\" ~ \"Puerto Colombia\",\n      TRUE ~ City ),\n   \n    Department = case_when(\n      Department == \"Archipielago de San Andres\" ~ \"Archipielago de San Andres, Providencia Y Santa Catalina\",\n      TRUE ~ Department )\n  )\n\n\n\n\n1.4.2 Merge Datasets\nWith the names corrected, we perform a dplyr::left_join() to add the Population column to our Ministery_DiagnosticData. The join is based on the unique key of City, Department, Year, Sex, and Age.\n\n\nCode\nMinistery_Data_with_pop &lt;- Ministery_DiagnosticData %&gt;%\n  left_join(Dane_Data_Total_long,\n            by = c(\"City\",  \n                   \"Department\",\n                   \"Year\",           \n                   \"Sex\",                 \n                   \"Age\"                   \n            ))\n\n# As a domain-specific step, we incorporate Bogota, D.C. into the Cundinamarca department\n# This treats Bogota as part of Cundinamarca for analysis.\nMinistery_Data_with_pop &lt;- Ministery_Data_with_pop %&gt;%\n  mutate(\n    Department = case_when(\n      Department == \"Bogota, D.C.\" ~ \"Cundinamarca\",\n      TRUE ~ Department )\n  )\n\n\nWe check for any remaining NAs and drop them, as they represent entries that could not be paired with a population count.\n\n\nCode\nMinistery_Data_with_pop &lt;- Ministery_Data_with_pop %&gt;%\n  drop_na()",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Data Cleaning and Processing</span>"
    ]
  },
  {
    "objectID": "0_NeuroColombia_DataCleaning.html#feature-engineering",
    "href": "0_NeuroColombia_DataCleaning.html#feature-engineering",
    "title": "1  Data Cleaning and Processing",
    "section": "1.5 Feature Engineering",
    "text": "1.5 Feature Engineering\nWe now engineer new variables to facilitate our analysis.\n\n1.5.1 Capital City Status\nWe create a binary variable Capital (“Yes” / “No”) to indicate if a city is a department capital. This is achieved by creating a capitals lookup table and joining it to our main dataset.\n\n\nCode\n# Create a lookup table for department capitals\ncapitals &lt;- tibble(\n  Department = c(\"Amazonas\", \"Antioquia\", \"Arauca\", \"Atlantico\", \"Bolivar\", \n                   \"Boyaca\", \"Caldas\", \"Caqueta\", \"Casanare\", \"Cauca\", \"Cesar\", \n                   \"Choco\", \"Cordoba\", \"Cundinamarca\", \"Guainia\", \"Guaviare\", \n                   \"Huila\", \"La Guajira\", \"Magdalena\", \"Meta\", \"Narino\", \n                   \"Norte de Santander\", \"Putumayo\", \"Quindio\", \"Risaralda\", \n                   \"Archipielago de San Andres, Providencia Y Santa Catalina\", \"Santander\", \"Sucre\", \"Tolima\", \n                   \"Valle del Cauca\", \"Vaupes\", \"Vichada\"),\n  CapitalCity = c(\"Leticia\", \"Medellin\", \"Arauca\", \"Barranquilla\", \"Cartagena\", \n                   \"Tunja\", \"Manizales\", \"Florencia\", \"Yopal\", \"Popayan\", \"Valledupar\", \n                   \"Quibdo\", \"Monteria\", \"Bogota, D.C.\", \"Inirida\", \"San Jose del Guaviare\", \n                   \"Neiva\", \"Riohacha\", \"Santa Marta\", \"Villavicencio\", \"Pasto\", \n                   \"Cucuta\", \"Mocoa\", \"Armenia\", \"Pereira\", \"San Andres\", \n                   \"Bucaramanga\", \"Sincelejo\", \"Ibague\", \"Cali\", \"Mitu\", \"Puerto Carreno\")\n)\n\n# Join with capitals lookup and create the \"Capital\" column\nMinistery_Data_with_capital &lt;- Ministery_Data_with_pop %&gt;%\n  left_join(capitals, by = \"Department\") %&gt;%\n  mutate(Capital = if_else(City == CapitalCity, \"Yes\", \"No\"))\n\n\n\n\n1.5.2 Normalized Diagnostic Rates\nUsing the new Population column, we calculate three normalized rates:\n\nDiagnostics_per_tenthousand: Cases per 10,000 inhabitants (of the reference population).\nDiagnostics_per_houndredthousand: Cases per 100,000 inhabitants (of the reference population).\nDiagnostics_Percentage: The raw percentage of the population diagnosed.\n\n\n\nCode\nMinistery_Data_Compiled &lt;- Ministery_Data_with_capital %&gt;%\n  mutate(Diagnostics_per_tenthousand = round((Cases / Population) * 10000))\n\nMinistery_Data_Compiled &lt;- Ministery_Data_Compiled %&gt;%\n  mutate(Diagnostics_per_houndredthousand = round((Cases / Population) * 100000))\n\nMinistery_Data_Compiled &lt;- Ministery_Data_Compiled %&gt;%\n  mutate(Diagnostics_Percentage = (Cases / Population))\n\n\n\n\n1.5.3 Diagnostic Groups\nFinally, we create a higher-level Diagnostic_Group column (e.g., F70, F80) using case_when() to bin the specific ICD-10 codes into broader categories.\n\n\nCode\nMinistery_Data_Compiled &lt;- Ministery_Data_Compiled %&gt;%\n  mutate(Diagnostic_Group = case_when(\n    Diagnostic %in% c(\"F700\", \"F701\", \"F708\", \"F709\", \"F711\", \"F710\", \"F718\", \"F719\", \"F720\", \"F721\", \"F728\", \"F729\", \"F730\", \"F731\", \"F738\", \"F739\",\"F780\", \"F781\", \"F788\", \"F789\", \"F790\", \"F799\", \"F798\", \"F791\") ~ \"F70\",\n    Diagnostic %in% c(\"F800\", \"F801\", \"F802\", \"F803\", \"F804\", \"F805\", \"F806\", \"F807\", \"F808\", \"F809\") ~ \"F80\",\n    Diagnostic %in% c(\"F810\", \"F811\", \"F812\", \"F813\", \"F818\", \"F8181\", \"F8189\", \"F819\") ~ \"F81\",\n    Diagnostic == \"F82\" ~ \"F82\",\n    Diagnostic == \"F83\" ~ \"F83\",\n    Diagnostic %in% c(\"F840\", \"F841\", \"F842\", \"F843\", \"F844\", \"F845\", \"F846\", \"F847\", \"F848\", \"F849\") ~ \"F84\",\n    Diagnostic == \"F88\" ~ \"F88\",\n    Diagnostic == \"F89\" ~ \"F89\",\n    Diagnostic %in% c(\"F900\", \"F901\", \"F908\", \"F909\") ~ \"F90\",\n    TRUE ~ NA_character_\n  ))",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Data Cleaning and Processing</span>"
    ]
  },
  {
    "objectID": "0_NeuroColombia_DataCleaning.html#final-export",
    "href": "0_NeuroColombia_DataCleaning.html#final-export",
    "title": "1  Data Cleaning and Processing",
    "section": "1.6 Final Export",
    "text": "1.6 Final Export\nWe save the fully cleaned, merged, and feature-engineered dataset. This file, Ministery_DiagnosticData_Compiled.csv, serves as the master dataset for all subsequent analysis chapters.\n\n\nCode\nwrite.csv(Ministery_Data_Compiled, \"Data_Processed/Ministery_DiagnosticData_Compiled.csv\", row.names = FALSE)",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Data Cleaning and Processing</span>"
    ]
  },
  {
    "objectID": "1_Consultation_Frequency.html",
    "href": "1_Consultation_Frequency.html",
    "title": "2  Consultation Frequency Analysis",
    "section": "",
    "text": "2.1 Load Project Setup\nThis first chunk sources the _common.R script. This single step loads all necessary packages, defines the global Plot_theme, and loads the primary Neuro_Data (prepared in Data Cleaning and Processing) and Col_map_fixed data frames into our environment.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Consultation Frequency Analysis</span>"
    ]
  },
  {
    "objectID": "1_Consultation_Frequency.html#consultations-per-year",
    "href": "1_Consultation_Frequency.html#consultations-per-year",
    "title": "2  Consultation Frequency Analysis",
    "section": "2.2 Consultations per Year",
    "text": "2.2 Consultations per Year\nThis section examines how the number of consultations for ICD-10 neurodevelopmental disorders changed over time in Colombia between 2016 and 2022. To provide an overview of long-term patterns, we aggregate the raw consultation records by calendar year. The resulting Summary_year dataset contains the total number of consultations reported in each year of the observation period.\n\n2.2.1 Data Preparation\nFirst, we create a summary table by grouping the main Neuro_Data by Year and summing all Cases for each year.\n\n\nCode\nSummary_year &lt;- Neuro_Data %&gt;%\n  group_by(Year) %&gt;%\n  summarise(Total_Cases = sum(Cases, na.rm = TRUE)) %&gt;%\n  ungroup()\n\nSummary_year\n\n\n# A tibble: 7 × 2\n   Year Total_Cases\n  &lt;int&gt;       &lt;int&gt;\n1  2016      154453\n2  2017      194102\n3  2018      231242\n4  2019      332318\n5  2020      179859\n6  2021      240548\n7  2022      283661\n\n\n\n\n2.2.2 Data Visualization\nWe visualize the yearly trend using a line and point plot. The y-axis labels are formatted with scales::cut_short_scale() to automatically display “K” for thousands, improving readability.\n\n\nCode\nCases_Year_fig &lt;- Summary_year %&gt;%\n  ggplot( aes(x= Year, y=Total_Cases)) +\n    geom_line( color=\"grey\", linewidth= 2) +\n    geom_point(shape=21, color=\"black\", fill=\"#69b3a2\", size=6) +\n    scale_y_continuous(name = expression (\"Number of consultations\"),\n                     labels = scales::label_number(scale_cut = scales::cut_short_scale())) +\n    ggtitle(\"ICD-10 neurodevelopmental disorders\") +\n    labs(x = \"Year\") +\n    Plot_theme\n\nggsave(Cases_Year_fig,\n       filename = \"Plots/Cases_Year_fig.png\",\n       width    = 14, \n       height   = 12, \n       units    = \"cm\")\n\nCases_Year_fig\n\n\n\n\n\n\n\n\nFigure 2.1: Distribution of consultation cases for neurodevelopmental disorders per year\n\n\n\n\n\nThe temporal trend is visualized using a line plot with points (Figure 4.3). The annual totals reveal a clear upward trajectory during the pre-pandemic years: consultations increased steadily from 154,453 cases in 2016 to a peak of 332,318 cases in 2019. In 2020, the first year of the COVID-19 pandemic, we observe a sharp decline to 179,859 cases, likely reflecting the widespread disruption of outpatient services and reduced healthcare access.\nFollowing this drop, the number of consultations rises again, reaching 240,548 cases in 2021 and 283,661 cases in 2022, though not yet returning to the 2019 peak. This temporal structure provides important context for interpreting subsequent spatial and demographic analyses, and motivates the need to examine how consultation patterns varied across departments and patient subgroups during this period.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Consultation Frequency Analysis</span>"
    ]
  },
  {
    "objectID": "1_Consultation_Frequency.html#geographical-distribution",
    "href": "1_Consultation_Frequency.html#geographical-distribution",
    "title": "2  Consultation Frequency Analysis",
    "section": "2.3 Geographical Distribution",
    "text": "2.3 Geographical Distribution\nIn this section, we explore how the intensity of neurodevelopmental consultations varies across Colombian departments. Instead of counting raw numbers of cases, we work with a standardized rate that makes regions comparable. For each municipality, we calculate the number of neurodevelopmental consultations per 10,000 individuals in the corresponding reference population (Diagnostics_per_tenthousand). The reference population matches the age structure and locality of the reported consultation.\n\n2.3.1 Data Preparation\nWe aggregate municipality-level rates at the departmental level. For each department, we compute the median number of consultations per 10,000 individuals across all municipalities in that department (MedianCases). Using the median keeps the summary robust against extreme values from very small or very large localities.\n\n\nCode\nSummary_Department &lt;- Neuro_Data %&gt;%\n  group_by(Department) %&gt;%\n  summarise(MedianCases = median(Diagnostics_per_tenthousand, na.rm = TRUE)) %&gt;%\n  ungroup()\n\n\n\n\n2.3.2 Results Table\nFor clarity, we present a table of the median number of consultations per department, conditioning on the reference population.\n\n\nCode\n# Sort data for the table\ndepartment_table_data &lt;- Summary_Department %&gt;%\n  arrange(desc(MedianCases))\n\n# Create the gt table\ndepartment_table &lt;- department_table_data %&gt;%\n  gt() %&gt;%\n  cols_label(\n    Department = \"Department\",\n    MedianCases = \"Median Cases\"\n  ) %&gt;%\n  fmt_number(\n    columns = MedianCases,\n    use_seps = TRUE,\n    decimals = 0\n  ) %&gt;%\n  theme_apa_gt()\n\n# Save the table files\ngtsave(department_table,\n       filename = \"Tables/Department_Summary_Table.html\")\ngtsave(department_table,\n       filename = \"Tables/Department_Summary_Table.tex\")\n\ndepartment_table\n\n\n\n\nTable 2.1: Total Cases by Department\n\n\n\n\n\n\n\n\n\nDepartment\nMedian Cases\n\n\n\n\nNarino\n97\n\n\nBoyaca\n78\n\n\nCaldas\n51\n\n\nTolima\n48\n\n\nSucre\n47\n\n\nCundinamarca\n45\n\n\nHuila\n43\n\n\nPutumayo\n43\n\n\nQuindio\n42\n\n\nCauca\n41\n\n\nBolivar\n39\n\n\nRisaralda\n37\n\n\nChoco\n36\n\n\nCaqueta\n35\n\n\nCasanare\n35\n\n\nSantander\n34\n\n\nAntioquia\n29\n\n\nNorte de Santander\n29\n\n\nVichada\n28\n\n\nArchipielago de San Andres, Providencia Y Santa Catalina\n26\n\n\nCesar\n26\n\n\nGuainia\n26\n\n\nAtlantico\n23\n\n\nCordoba\n22\n\n\nValle del Cauca\n22\n\n\nVaupes\n22\n\n\nArauca\n21\n\n\nLa Guajira\n21\n\n\nMeta\n20\n\n\nAmazonas\n18\n\n\nGuaviare\n18\n\n\nMagdalena\n16\n\n\n\n\n\n\n\n\n\n\nThe resulting table ranks departments by their median rate of consultations. Departments such as Nariño (median 97 consultations per 10,000 individuals), Boyacá (78), Caldas (51), Tolima (48), and Sucre (47) stand out with the highest typical consultation intensities.\n\n\n2.3.3 Generating a Map of Colombia\nTo visualize this pattern, we join the departmental summaries with the GADM shapefile and generate a choropleth map of Colombia. Each department appears with a color that reflects its median consultation rate. This map highlights clusters of high and low consultation intensity and helps identify regions where the healthcare system records more frequent neurodevelopmental assessments relative to the local population.\nTo join the case data with the map geometry, we use the Col_map_fixed object (loaded from _common.R) and perform a left_join with our Summary_Department data.\n\n\nCode\nMap_df &lt;- Col_map_fixed %&gt;%\n  left_join(Summary_Department, by = \"Department\")\n\n\n\n\n2.3.4 Consultation by Department\nWe plot the total number of cases by department. To highlight the most-affected regions, we create a top_5_data subset and use geom_sf_text to overlay their labels on the map. The fill scale is square-root-transformed (trans = \"sqrt\") to better visualize the distribution, and labels are formatted to “K” for thousands.\n\n\nCode\n# Create a data frame for the top 5 labels\ntop_5_data &lt;- Map_df %&gt;%\n  slice_max(order_by = MedianCases, n = 5)\n\n# Create the map\nDepartment_map &lt;- ggplot(Map_df) +\n  geom_sf(aes(fill = MedianCases), colour = \"white\", size = 0.2) +\n  \n  # Add the text labels for the top 5\n  geom_sf_text(\n    data = top_5_data,\n    aes(label = Department), \n    color = \"white\",\n    size = 5,\n    check_overlap = TRUE\n  ) +\n  \n  scale_fill_viridis_c(\n    option    = \"viridis\",\n    direction = -1,\n    trans     = \"sqrt\",   \n    name      = \"Median number of consultations \\nper 10.000 (reference population)\",\n    guide = guide_colorbar(\n      barwidth     = unit(12, \"cm\"),  \n      barheight    = unit(0.8, \"cm\")  \n    )\n  ) +\n  labs(title = \"Consultations per department (2016-2022)\") +\n  theme_minimal() +\n  Plot_theme +\n  theme(\n    plot.title = element_text(size=22, face=\"bold\", vjust = 2),\n    axis.text.y = element_blank(),\n    axis.text.x = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.ticks.x = element_blank(),\n    legend.position = \"bottom\",\n    legend.direction = \"horizontal\",\n    legend.title = element_text(colour=\"black\", face=\"bold\", size=16),\n    legend.text = element_text(colour=\"black\", size=16),\n    strip.text = element_text(size = 20)\n  ) \n\nggsave(Department_map,\n       filename = \"Plots/Department_map.png\",\n       width    = 22, \n       height   = 25, \n       units    = \"cm\")\n\n\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n\n\nCode\nDepartment_map\n\n\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n\n\n\n\n\n\n\n\nFigure 2.2: Cases by department and capital status",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Consultation Frequency Analysis</span>"
    ]
  },
  {
    "objectID": "1_Consultation_Frequency.html#consultations-conditional-on-capital-city",
    "href": "1_Consultation_Frequency.html#consultations-conditional-on-capital-city",
    "title": "2  Consultation Frequency Analysis",
    "section": "2.4 Consultations Conditional on Capital City",
    "text": "2.4 Consultations Conditional on Capital City\nIn this section, we examine how consultation intensity differs between departmental capitals and the rest of the municipalities. We calculate the consultation rate for each municipality as the number of neurodevelopmental consultations per 10,000 individuals in the matched reference population. We then group municipalities by whether they belong to a departmental capital and summarize each group using the median and standard deviation.\n\n2.4.1 Data Preparation\n\n\nCode\nSummary_Capital &lt;- Neuro_Data %&gt;%\n  group_by(Capital, Department) %&gt;%\n  summarise(\n  Median_Cases_Capitals = median(Diagnostics_per_tenthousand, na.rm = TRUE),\n  ) %&gt;%\n  ungroup()\n\n\n`summarise()` has grouped output by 'Capital'. You can override using the\n`.groups` argument.\n\n\n\n\n2.4.2 Data Visualization\nWe use a ridge plot (ggridges) to visualize the distribution of median consultation rates, comparing capital and non-capital departments. To make the plot more informative, we pre-calculate the Median and SD for each group and overlay this text directly onto the plot using geom_text.\n\n\nCode\nlibrary(ggridges) # For the ridge plot\nlibrary(dplyr)    # For calculating the stats\n\n# --- 1. Create the summary statistics data frame ---\n# We calculate the median and SD for each 'Capital' group\nstats_data &lt;- Summary_Capital %&gt;%\n  group_by(Capital) %&gt;%\n  summarise(\n    Median = median(Median_Cases_Capitals, na.rm = TRUE),\n    SD = sd(Median_Cases_Capitals, na.rm = TRUE)\n  ) %&gt;%\n  ungroup() %&gt;%\n  # Create a text label with line breaks (\\n)\n  mutate(\n    summary_label = sprintf(\"Median: %.1f\\nSD: %.1f\", Median, SD)\n  )\n\n# --- 2. Create the plot ---\nCases_Capital_fig &lt;- Summary_Capital %&gt;%\n  ggplot(aes(x = Median_Cases_Capitals, y = Capital, fill = Capital)) +\n  \n  # Draw the ridges\n  geom_density_ridges(alpha = 0.7) +\n  \n  # --- 3. Add the summary text ---\n  # We use the new 'stats_data' data frame\n  # inherit.aes = FALSE stops it from interfering with the main plot\n  geom_text(\n    data = stats_data,\n    inherit.aes = FALSE,\n    # Place text at the Median (x) and on the correct Capital ridge (y)\n    aes(x = Median, y = Capital, label = summary_label), \n    color = \"black\",  # Text color\n    size = 3.5,       # Text size\n    vjust = -0.5,     # Vertical justification (move text *up*)\n    hjust = -0.5         # Horizontal justification (start text at the median)\n  ) +\n  \n  ggtitle(\"\") +\n  \n  scale_fill_manual(\n    name = \"Capital city\",\n    values = c(\"#D9717D\", \"#4DB6D0\"),\n    labels = c(\"No\", \"Yes\")\n  ) +\n  \n  labs(y = \"Capital city status\",\n       x = \"Median number of consultations \\n per 10.000 (reference population)\") +\n  \n  # Widen the x-axis to make room for the text\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.2))) +\n  \n  Plot_theme +\n  theme (legend.position = \"none\",\n         axis.text.x = element_text(hjust = 1)) \n\nggsave(Cases_Capital_fig,\n       filename = \"Plots/Cases_Capital_fig.png\",\n       width    = 14,\n       height   = 12, \n       units    = \"cm\")\n\n\nPicking joint bandwidth of 6.21\n\n\nCode\nCases_Capital_fig\n\n\nPicking joint bandwidth of 6.21\n\n\n\n\n\n\n\n\nFigure 2.3: Distribution of median neurodevelopmental diagnostic cases by capital status, with summary statistics.\n\n\n\n\n\nWe visualize these distributions using a density ridgeline plot, which makes the difference in scale immediately visible. Departmental capital cities report a median of 8 consultations per 10,000 inhabitants (SD = 10), whereas non-capital municipalities show a much higher median of 51.5 consultations per 10,000 inhabitants (SD = 111.7). This pattern suggests that individuals living outside departmental capitals tend to engage more with neurodevelopmental services relative to their population size, even though capital cities host the largest and most specialized medical centers.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Consultation Frequency Analysis</span>"
    ]
  },
  {
    "objectID": "1_Consultation_Frequency.html#geographical-distribution-by-sex",
    "href": "1_Consultation_Frequency.html#geographical-distribution-by-sex",
    "title": "2  Consultation Frequency Analysis",
    "section": "2.5 Geographical Distribution by Sex",
    "text": "2.5 Geographical Distribution by Sex\nIn this section, we examine how consultation intensity differs between men and women across Colombian departments. Using the population-standardized rate of neurodevelopmental consultations per 10,000 inhabitants, we first summarize the median rate for each sex within each department across all available years. This aggregation produces a sex-stratified map of consultation intensity that allows direct comparison between regions.\n\n\nCode\nlibrary(dplyr)\n\nSummary_Sex &lt;- Neuro_Data %&gt;%\n  group_by(Department, Sex) %&gt;%\n  summarise(\n    MedianCases = round(median(Diagnostics_per_tenthousand, na.rm = TRUE), digits = 0),\n  ) %&gt;%\n  ungroup() \n\n\n`summarise()` has grouped output by 'Department'. You can override using the\n`.groups` argument.\n\n\nWe join this information to the Colombian map:\n\n\nCode\nMap_df &lt;- Col_map_fixed %&gt;%\n  left_join(Summary_Sex, by = \"Department\")\n\n#We exclude NAs\nMap_df &lt;- Map_df %&gt;%\n  filter(!is.na(MedianCases))\n\n\nThen, we use geom_sf to plot the resulting maps and label the top ten counts:\n\n\nCode\ntop_10_data &lt;- Map_df %&gt;%\n  slice_max(order_by = MedianCases, n = 10)\n\nCases_Sex_map &lt;- ggplot(Map_df) +\n  geom_sf(aes(fill = MedianCases), colour = \"white\", size = 0.2) +\n  scale_fill_viridis_c(\n    option    = \"viridis\",\n    limits = c(0, 120),\n    direction = -1,\n    name      = \"Median number of consultations \\nper 10.000 (reference population)\",\n    guide = guide_colorbar(\n      barwidth        = unit(10, \"cm\"),  \n      barheight       = unit(0.5, \"cm\")   \n    )\n  ) +\n  \n  # Add the text labels for the top 10\n  geom_sf_text(\n    data = top_10_data,\n    aes(label = Department), \n    color = \"black\",\n    size = 4,\n    check_overlap = TRUE\n  ) +\n  \n  facet_wrap(~ Sex) +\n  labs(title = \"Consultation per biological sex\") +\n  theme_minimal() +\n  Plot_theme +\n  theme(\n    axis.text.y = element_blank(),\n    axis.text.x = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.ticks.x = element_blank(),\n    legend.position = \"bottom\",\n    legend.direction = \"horizontal\",\n    strip.text = element_text(size = 12)\n  ) \n\nggsave(Cases_Sex_map,\n       filename = \"Plots/Cases_Sex_map.png\",\n       width    = 25, \n       height   = 15, \n       units    = \"cm\")\n\n\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n\n\nCode\nCases_Sex_map \n\n\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n\n\n\n\n\n\n\n\nFigure 2.4: Distribution of consultations per department and capital city status\n\n\n\n\n\nWe observe that the resulting distribution is not uniform in Figure 2.4. Men show several departments with particularly high consultation rates, including Nariño (109 per 10,000), Boyacá (85), Caldas (57), Cundinamarca (52), and Putumayo (51). Women show a similar pattern but with overall lower values; the highest consultation rates occur in Nariño (89) and Boyacá (65). These sex-specific maps highlight areas where diagnostic engagement is substantially higher for one group than the other and provide geographical context for interpreting the statistical models developed in later sections.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Consultation Frequency Analysis</span>"
    ]
  },
  {
    "objectID": "1_Consultation_Frequency.html#statistical-modeling",
    "href": "1_Consultation_Frequency.html#statistical-modeling",
    "title": "2  Consultation Frequency Analysis",
    "section": "2.6 Statistical Modeling",
    "text": "2.6 Statistical Modeling\nWe model the mean consultation rate as a function of biological sex, allowing both the baseline level and the sex effect to vary across departments. This structure lets each department have its own overall consultation level and its own difference between men and women, while still borrowing strength across departments.\nFirst, we write the likelihood using a Student-t distribution to remain robust to extreme values:\n\\[\n\\text{MeanCases}_{ij} \\sim \\text{Student}(\\nu,\\; \\mu_{ij},\\; \\sigma)\n\\]\nwhere \\(\\nu\\) is the degrees-of-freedom parameter, \\(\\sigma\\) is the residual scale, and the linear predictor \\(\\mu_{ij}\\) is\n\\[\n\\mu_{ij}\n= \\beta_0 + \\beta_{\\text{Sex}} \\,\\text{Sex}_{ij}\n+ u_{0j} + u_{1j}\\,\\text{Sex}_{ij}.\n\\]\nExplanation of terms in the linear predictor:\n\n\\(\\beta_0\\): global intercept (mean rate for men in an average department)\n\\(\\beta_{\\text{Sex}}\\): global average difference between women and men\n\\(u_{0j}\\): department-specific deviation from the global intercept (random intercept)\n\\(u_{1j}\\): department-specific deviation from the global sex effect (random slope for Sex)\n\nWe collect the department-level random effects in a bivariate normal distribution:\n\\[\n\\begin{pmatrix}\nu_{0j} \\\\\nu_{1j}\n\\end{pmatrix}\n\\sim\n\\mathcal{N}\\!\\left(\n\\begin{pmatrix}\n0 \\\\\n0\n\\end{pmatrix},\n\\;\n\\begin{pmatrix}\n\\sigma_{\\text{int}}^{2} &\n\\rho\\,\\sigma_{\\text{int}}\\sigma_{\\text{sex}} \\\\\n\\rho\\,\\sigma_{\\text{int}}\\sigma_{\\text{sex}} &\n\\sigma_{\\text{sex}}^{2}\n\\end{pmatrix}\n\\right).\n\\]\nWhere:\n\n\\(\\sigma_{\\text{int}}\\): standard deviation of department intercepts (between-department differences in baseline rate)\n\\(\\sigma_{\\text{sex}}\\): standard deviation of department-specific sex effects\n\\(\\rho\\): correlation between intercepts and sex effects\n\nWe fit this hierarchical Student-t model in brms using four MCMC chains with 5,000 iterations each (2,500 warmup). We set a high adapt_delta and max_treedepth to obtain stable sampling for the heavy-tailed likelihood and the random-effects structure. We rely on the default weakly informative priors defined by brms, so we do not inject additional substantive information into the model beyond the data.\n\n2.6.1 Prepare the Data\nWe rewrite the Summary_Sex variable to have cities as observations to make a more precise estimation.\n\n\nCode\nSummary_Sex &lt;- Neuro_Data %&gt;%\n  group_by(City, Department, Sex) %&gt;%\n  summarise(\n    MeanCases = round(mean(Diagnostics_per_tenthousand, na.rm = TRUE), digits = 0),\n  ) %&gt;%\n  ungroup() \n\n\n`summarise()` has grouped output by 'City', 'Department'. You can override\nusing the `.groups` argument.\n\n\n\n\n2.6.2 Fit the Model\nWe use brms to fit our hierarchical model.\n\n\nCode\n# Model formula\nCases_Sex_Mdl1 &lt;- bf(MeanCases ~ Sex + (Sex | Department))\n               \n# List priors and variables\nget_prior(Cases_Sex_Mdl1, Summary_Sex, family = student)\n\n# Fit model 1\nCases_Sex_Fit1 &lt;- \n  brm(\n    family  = student,\n    data    = Summary_Sex,\n    formula = Cases_Sex_Mdl1,\n    chains  = 4,\n    cores   = 4,\n    warmup  = 2500, \n    iter    = 5000, \n    seed    = 8807,\n    control = list(adapt_delta = 0.99, max_treedepth = 15),\n    file    = \"Models/Cases_Sex_Fit1.rds\",\n    file_refit = \"never\")\n\n\n\n\n2.6.3 Model Results\nThe hierarchical model quantifies how consultation intensity differs between sexes after accounting for geographical variation. The intercept represents the expected mean number of consultations per 10,000 inhabitants for men, averaged across departments and years.\n\n\nCode\ntbl_cases_sex &lt;- tbl_regression(\n  x            = Cases_Sex_Fit1,\n  intercept    = TRUE,\n  estimate_fun = ~ style_sigfig(., digits = 2),\n  conf.level   = 0.95\n) %&gt;%\n  modify_header(\n    label    ~ \"**Predictor**\",\n    estimate ~ \"**Estimate**\",\n    ci       ~ \"**95% CI**\"\n  ) %&gt;%\n  bold_labels() %&gt;%\n  modify_caption(\n    \"**Table 1. Effect of biological sex on neurodevelopmental consultation rates**\"\n  )\n\ntbl_cases_sex \n\n\n\n\nTable 2.2: Table 1. Effect of biological sex on neurodevelopmental consultation rates\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPredictor\nEstimate\n95% CI\n95% CI1\n\n\n\n\n(Intercept)\n94\n77, 112\n77, 112\n\n\nSex\n\n\n\n\n\n\n\n\n    SexWomen\n-5.0\n-11, 1.1\n-11, 1.1\n\n\n\n1 CI = Credible Interval\n\n\n\n\n\n\n\n\n\n\n\nThe intercept in Table 4.5 represents the expected mean number of consultations per 10,000 inhabitants for men in an average department. The model estimates this baseline at 94 consultations (95 % CI: 77–112), which reflects the national-level average once we account for department-level heterogeneity. The coefficient for Women (SexWomen) captures the global average difference in consultation rate between women and men across the country. The model estimates this effect as −5 consultations per 10,000 inhabitants (95 % CI: −11 to −1.1). This negative estimate indicates that, on average, women show lower consultation rates than men. Importantly, this fixed effect represents the population-level average, while the random slope structure in the model allows each department to deviate from this mean sex effect.\nWe save the results tables as LaTeX and Word documents:\n\n2.6.3.1 Posterior Draws\nThe hierarchical model allows us to generate posterior predictive distributions for the consultation rate of men and women, while incorporating uncertainty in both the fixed effects and the department-specific random effects. Using the fitted model, we draw predictions for each combination of sex and department and summarize these draws.\n\n\nCode\nset.seed(8807)\n\nsex_predicted_draws &lt;- Summary_Sex %&gt;%\n  group_by(Sex, Department) %&gt;% # Ensure we consider the department-level grouping\n  add_predicted_draws(Cases_Sex_Fit1, re_formula = NA) # re_formula = NA to include all random effects\n\n# Plotting\nCases_Sex_Fig1 &lt;- ggplot(sex_predicted_draws, aes(x = Sex, y = .prediction, fill = Sex)) +\n  stat_halfeye() + \n  geom_jitter(data = Summary_Sex, aes(x = Sex, y = MeanCases, color = Sex),\n              width = 0.2, alpha = 0.4, size = 0.4) + \n  geom_point(data = sex_predicted_draws %&gt;% group_by(Sex, Department) %&gt;% summarise(MeanCases = mean(.prediction)), \n             aes(x = Sex, y = MeanCases, color = Sex), \n             shape = 1, size = 2, show.legend = FALSE) + \n \n  labs(caption = \"Model: MeanCases ~ Sex + (Sex | Department)\",\n       y = \"Mean number of consultations \\nper 10.000 (reference population)\",\n       x = \"\") +\n  ylim(0, 600) +\n  Plot_theme +\n  theme(legend.position = \"none\") +\n  theme(text = element_text(size = 24)) +\n  coord_flip()\n\n\n`summarise()` has grouped output by 'Sex'. You can override using the `.groups`\nargument.\n\n\nCode\nggsave(Cases_Sex_Fig1,\n       filename = \"Plots/Cases_Sex_Fig1.png\",\n       width    = 12, \n       height   = 10, \n       units    = \"cm\")\n\n\nWarning: Removed 3193787 rows containing missing values or values outside the scale\nrange (`stat_slabinterval()`).\n\n\nWarning: Removed 68 rows containing missing values or values outside the scale range\n(`geom_point()`).\n\n\nCode\nCases_Sex_Fig1 \n\n\nWarning: Removed 3193787 rows containing missing values or values outside the scale\nrange (`stat_slabinterval()`).\nRemoved 68 rows containing missing values or values outside the scale range\n(`geom_point()`).\n\n\n\n\n\n\n\n\nFigure 2.5: Posterior distribution for the number of neurodevelopmental diagnostics per biological sex\n\n\n\n\n\nThe coloured half-eye shapes represent the posterior predictive distribution of the mean number of consultations per 10,000 inhabitants for each sex, averaged across departments. The open circles show the average predicted value for each sex, and the horizontal black intervals mark the corresponding 95% credible intervals. We overlay the observed department-by-year means as jittered points, which lets us visually compare the model-based predictions with the empirical data.\nThe posterior distributions for men and women clearly separate. At the same time, the observed points for both sexes fall largely within the corresponding predictive distributions, indicating that the model captures the magnitude and spread of the data reasonably well.\n\n\n2.6.3.2 Contrast Between Biological Sex\nTo summarize the overall effect of biological sex, we extract the posterior samples of the fixed effect for women (b_SexWomen) from the hierarchical model. This coefficient represents the average difference in consultation rate between women and men across all departments, after accounting for department-specific intercepts and sex slopes.\n\n\nCode\n# Extract posterior samples for the treatment effect\nsex_posterior_samples &lt;- posterior_samples(Cases_Sex_Fit1, pars = c(\"b_SexWomen\"))\n\n\nWarning: Method 'posterior_samples' is deprecated. Please see ?as_draws for\nrecommended alternatives.\n\n\nCode\n# Convert to a data frame for ggplot\nsex_posterior_df &lt;- as.data.frame(sex_posterior_samples)\n\n# Visualizing the Treatment effect size with uncertainty\nCases_Sex_Fig2 &lt;- ggplot(sex_posterior_df, aes(x = b_SexWomen)) +\n  stat_halfeye() +\n  geom_vline(xintercept = 0, linetype = \"dashed\", color = \"red\", size = 1) +\n  labs(title = \"Mean number of consultations\",\n    caption = \"Model: MeanCases ~ Sex + (Sex | Department)\",\n    x = \"Effect Size (Women)\",\n       y = \"Density\") +\n  Plot_theme +\n  theme(text = element_text(size = 30))\n\n\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nℹ Please use `linewidth` instead.\n\n\nCode\nggsave(Cases_Sex_Fig2,\n       filename = \"Plots/Cases_Sex_Fig2.png\",\n       width    = 12, \n       height   = 10, \n       units    = \"cm\")\n\nCases_Sex_Fig2 \n\n\n\n\n\n\n\n\nFigure 2.6: Effect size for Women\n\n\n\n\n\nFigure 2.6 shows the posterior distribution of this global sex effect. The horizontal axis corresponds to the difference in the mean number of consultations per 10,000 inhabitants for women relative to men. The vertical dashed line at zero marks the point of no difference between sexes. The posterior mass lies entirely below zero, with a posterior mean of approximately −8.6 consultations per 10,000 inhabitants and a 95% credible interval from −11 to −6.1. This distribution indicates that, on average, women have lower consultation rates than men.\n\n\n2.6.3.3 Department-level Variability in Baseline Consultation Rates\nTo quantify how much departments differ in their overall consultation intensity, we examine the posterior distribution of the standard deviation of the department intercepts. This parameter \\(\\sigma_{\\text{int}}\\) measures the spread of the department-specific baseline effects after we adjust for sex and allow sex differences to vary by department.\n\n\nCode\n# Extract posterior samples for the random effect\ndepartment_posterior_samples &lt;- posterior_samples(Cases_Sex_Fit1, pars = c(\"^sd_\"))\n\n\nWarning: Method 'posterior_samples' is deprecated. Please see ?as_draws for\nrecommended alternatives.\n\n\nCode\n# Convert to a data frame for ggplot\ndepartment_posterior_df &lt;- as.data.frame(department_posterior_samples)\n\n# Visualizing the Treatment effect size with uncertainty\nCases_Sex_Fig3 &lt;- ggplot(department_posterior_df, aes(x = sd_Department__Intercept)) +\n  stat_halfeye() +\n  geom_vline(xintercept = 0, linetype = \"dashed\", color = \"red\", size = 1) +\n  labs(caption = \"Model: Cases ~ Sex + (sex | Department)\",\n       x = \"Department (sd)\",\n       y = \"Density\") +\n  Plot_theme +\n  theme(text = element_text(size = 30))\n\nggsave(Cases_Sex_Fig3,\n       filename = \"Plots/Cases_Sex_Fig3.png\",\n       width    = 12, \n       height   = 10, \n       units    = \"cm\")\n\nCases_Sex_Fig3 \n\n\n\n\n\n\n\n\nFigure 2.7: Standart deviation for the random effects variable (department)\n\n\n\n\n\nFigure 2.7 displays the posterior distribution of this standard deviation. The entire distribution lies far from zero and concentrates around relatively large values, indicating marked variability in baseline consultation rates across departments. In other words, even before considering sex-specific differences, some departments show much higher overall consultation rates than others. This result complements the descriptive maps and confirms that geographical heterogeneity is a central feature of the data.\n\n\n2.6.3.4 Department-specific Effects of Biological Sex\nBecause our model includes a random slope for sex, we can examine how the effect of being a woman varies across departments. For each department, we combine the global sex effect (b_SexWomen) with the department-specific deviation in the sex slope to obtain a posterior distribution of the sex effect in that department. These department-level effects represent the difference in mean consultation rate between women and men (women minus men) on the scale of cases per 10,000 inhabitants.\n\n\nCode\n# 1. Posterior draws for fixed and random sex effects\npost &lt;- posterior_samples(Cases_Sex_Fit1)\n\n\nWarning: Method 'posterior_samples' is deprecated. Please see ?as_draws for\nrecommended alternatives.\n\n\nCode\nsex_draws_long &lt;- post %&gt;%\n  mutate(.draw = row_number()) %&gt;%\n  # keep global sex effect + all department random effects\n  select(.draw, b_SexWomen, starts_with(\"r_Department[\")) %&gt;%\n  # reshape to long format\n  pivot_longer(\n    starts_with(\"r_Department[\"),\n    names_to  = \"param\",\n    values_to = \"r_SexWomen\"\n  ) %&gt;%\n  # keep only random slopes for SexWomen\n  filter(str_detect(param, \",SexWomen\\\\]\")) %&gt;%\n  # extract department name between \"[\" and \",SexWomen]\"\n  mutate(\n    Department = str_extract(param, \"(?&lt;=\\\\[).*(?=,SexWomen\\\\])\"),\n    sex_effect_dept = b_SexWomen + r_SexWomen\n  )\n\n# 2. Plot department-specific sex effects\nCases_Sex_Fig4 &lt;- ggplot(\n  sex_draws_long,\n  aes(x = sex_effect_dept,\n      y = reorder(Department, sex_effect_dept))\n) +\n  stat_halfeye(color = \"black\") +\n  geom_vline(xintercept = 0, linetype = \"dashed\",\n             color = \"red\", linewidth = 1) +\n  scale_y_discrete(labels = function(x) recode(x,\n    \"Valle.del.Cauca\"            = \"Valle\",\n    \"La.Guajira\"                = \"Guajira\",\n    \"Archipielago.de.San.Andres,.Providencia.Y.Santa.Catalina\" = \"San Andrés\",\n    \"Norte.de.Santander\"         = \"N. Santander\"\n  )) +\n  labs(\n    caption = \"Model: MeanCases ~ Sex + (Sex | Department)\",\n    x       = \"Sex effect (Women – Men, cases per 10,000)\",\n    y       = \"Department\"\n  ) +\n  Plot_theme +\n  theme(text = element_text(size = 30))\n\nggsave(\n  Cases_Sex_Fig4,\n  filename = \"Plots/Cases_Sex_Fig4.png\",\n  width    = 18,\n  height   = 20,\n  units    = \"cm\"\n)\n\nCases_Sex_Fig4\n\n\n\n\n\n\n\n\nFigure 2.8: Department-specific effects of biological sex on consultation rates\n\n\n\n\n\nFigure 2.8 displays posterior distributions. Each half-eye corresponds to one department. Negative values indicate departments where women have lower consultation rates than men, whereas positive values would indicate the opposite. The vertical dashed line at zero marks the point of no difference between sexes.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Consultation Frequency Analysis</span>"
    ]
  },
  {
    "objectID": "2_Consultation_DiagnosticFrecuency.html",
    "href": "2_Consultation_DiagnosticFrecuency.html",
    "title": "3  Diagnostic Frequency Analysis",
    "section": "",
    "text": "3.1 Load Project Setup\nThis chunk sources the _common.R script, which loads all packages, the Plot_theme, and the main Neuro_Data data frame.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Diagnostic Frequency Analysis</span>"
    ]
  },
  {
    "objectID": "2_Consultation_DiagnosticFrecuency.html#consultations-per-diagnostic",
    "href": "2_Consultation_DiagnosticFrecuency.html#consultations-per-diagnostic",
    "title": "3  Diagnostic Frequency Analysis",
    "section": "3.2 Consultations per Diagnostic",
    "text": "3.2 Consultations per Diagnostic\nWe begin by examining how often each diagnostic category appears in the consultation records. This provides a broad overview of the distribution of neurodevelopmental conditions in the dataset and helps us identify which diagnoses account for the largest share of consultations.\n\n3.2.1 Data Preparation\nWe group the full dataset by diagnostic category and compute the total number of consultations associated with each condition. This step collapses the dataset across departments and years, allowing us to quantify the overall importance of each diagnostic group at the national level.\n\n\nCode\nSummary_Diagnostic &lt;- Neuro_Data %&gt;%\n  group_by(Diagnostic) %&gt;%\n  summarise(Total_Cases = sum(Cases, na.rm = TRUE)) %&gt;%\n  ungroup()\n\nSummary_Diagnostic\n\n\n# A tibble: 51 × 2\n   Diagnostic Total_Cases\n   &lt;chr&gt;            &lt;int&gt;\n 1 F700             24236\n 2 F701             11144\n 3 F708              7298\n 4 F709              7252\n 5 F710             12251\n 6 F711             10112\n 7 F718              4458\n 8 F719              5700\n 9 F720              2327\n10 F721              5306\n# ℹ 41 more rows\n\n\n\n\n3.2.2 Data Visualization: Top 10 Diagnostics\nThe full dataset contains dozens of diagnostic categories, and plotting all of them at once would obscure meaningful patterns. To focus on the most prevalent conditions, we extract the 10 diagnostic categories with the highest number of consultations using slice_max(). The bar chart in Figure 3.1 displays these top diagnoses, ordered from the most to the least frequent. We annotate each bar with the exact number of consultations and use a color gradient to highlight the relative magnitude of each category.\n\n\nCode\n# Filter for the 10 most frequent cases\ntop_10_data &lt;- Summary_Diagnostic %&gt;%\n  slice_max(Total_Cases, n = 10)\n\n# Create the bar plot\nDiagnostic_fig_Top10 &lt;- ggplot(top_10_data, \n                               aes(y = reorder(Diagnostic, Total_Cases), # Re-ordered smallest to largest for this plot\n                                   x = Total_Cases,\n                                   fill = Total_Cases)) +\n  geom_bar(stat = \"identity\") +\n  scale_fill_distiller(palette = \"Blues\", direction = 1) +\n  geom_text(aes(label=Total_Cases), vjust=0.5, hjust = -0.1, color=\"black\", size=4) +\n  labs(x = \"Total cases\", y = \"ICD-10 nerodevelopmental diagnostics\", \n       title = \"10 most frequent consultations\") +\n  Plot_theme + \n  theme(axis.text.x=element_blank(),\n        axis.ticks.x=element_blank(),\n        legend.position = \"none\") +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.15)))\n\n# Save the new figure\nggsave(Diagnostic_fig_Top10,\n       filename = \"Plots/Diagnostic_fig_Top10.png\",\n       width    = 16, \n       height   = 15,\n       units    = \"cm\")\n\nDiagnostic_fig_Top10\n\n\n\n\n\n\n\n\nFigure 3.1: Distribution of the 10 most frequent neurodevelopmental diagnostics (CIE-11).\n\n\n\n\n\nThe distribution of consultations is heavily concentrated in a small number of diagnostic categories. The hyperactive disorder diagnosis (F900) is by far the most common, with more than 300,000 consultations. Other highly frequent diagnoses include mixed developmental disorders (F809) and speech and language disorders (F808), each surpassing 200,000 consultations. Even the least frequent categories in the top 10 exceed 80,000 consultations, indicating that a limited set of neurodevelopmental conditions dominate the national consultation load.\n\n\n3.2.3 Full Diagnostic Table\nTo provide a complete overview of the diagnostic spectrum, we construct a table that lists all ICD-10 neurodevelopmental diagnostic categories and their total number of consultations. Because the full list is long, we sort the diagnostics from most to least frequent and then distribute them into three column groups. We format the resulting wide table with gt, add column group headings, and apply a simple APA-style layout. The table is exported both as LaTeX (for direct inclusion in the manuscript) and as a Word document, so that readers and collaborators can easily reuse or adapt the information.\n\n\nCode\n# --- 1. Sort the data ---\nsorted_data &lt;- Summary_Diagnostic %&gt;%\n  arrange(desc(Total_Cases))\n\n# --- 2. Prepare data for 3 columns ---\nn_rows &lt;- nrow(sorted_data)\nrows_per_col &lt;- ceiling(n_rows / 3)\nna_row &lt;- tibble(Diagnostic = NA_character_, Total_Cases = NA_integer_)\n\ncol1 &lt;- sorted_data %&gt;% slice(1:rows_per_col)\ncol2 &lt;- sorted_data %&gt;% slice((rows_per_col + 1):min(2 * rows_per_col, n_rows))\ncol3 &lt;- sorted_data %&gt;% slice((2 * rows_per_col + 1):n_rows)\n\n# Pad shorter columns with NA rows\nif (nrow(col2) &lt; rows_per_col) {\n  col2 &lt;- bind_rows(col2, slice(na_row, rep(1, rows_per_col - nrow(col2))))\n}\nif (nrow(col3) &lt; rows_per_col) {\n  col3 &lt;- bind_rows(col3, slice(na_row, rep(1, rows_per_col - nrow(col3))))\n}\n\n# --- 4. Combine into one wide dataframe ---\nmulti_col_data &lt;- bind_cols(\n  col1 %&gt;% rename(Diagnostic_1 = Diagnostic, Cases_1 = Total_Cases),\n  col2 %&gt;% rename(Diagnostic_2 = Diagnostic, Cases_2 = Total_Cases),\n  col3 %&gt;% rename(Diagnostic_3 = Diagnostic, Cases_3 = Total_Cases)\n)\n\n\n\n3.2.3.1 Results Table\nThe prepared multi_col_data is formatted with gt. We use tab_spanner to create “Group 1”, “Group 2”, and “Group 3” headers over the columns.\n\n\nCode\npublication_table_gt &lt;- multi_col_data %&gt;%\n  gt() %&gt;%\n  tab_header(\n    title    = md(\"**Table 2. Consultations by ICD-10 neurodevelopmental diagnostic category**\"),\n    subtitle = \"Sorted from most to least frequent and arranged in three column groups.\"\n  ) %&gt;%\n  # Column groupings\n  tab_spanner(label = \"Group 1\", columns = c(Diagnostic_1, Cases_1)) %&gt;%\n  tab_spanner(label = \"Group 2\", columns = c(Diagnostic_2, Cases_2)) %&gt;%\n  tab_spanner(label = \"Group 3\", columns = c(Diagnostic_3, Cases_3)) %&gt;%\n  # Column labels under the spanners\n  cols_label(\n    Diagnostic_1 = \"Diagnostic\", Cases_1 = \"Cases\",\n    Diagnostic_2 = \"Diagnostic\", Cases_2 = \"Cases\",\n    Diagnostic_3 = \"Diagnostic\", Cases_3 = \"Cases\"\n  ) %&gt;%\n  # Number formatting\n  fmt_number(\n    columns  = c(Cases_1, Cases_2, Cases_3),\n    use_seps = TRUE,\n    decimals = 0\n  ) %&gt;%\n  # Show padded NAs as blank cells\n  fmt_missing(\n    columns      = everything(),\n    missing_text = \"\"\n  ) %&gt;%\n  theme_apa_gt() %&gt;%\n  tab_source_note(\n    source_note = \"Note. ICD-10 neurodevelopmental diagnostics, ordered by total number of consultations.\"\n  )\n\npublication_table_gt\n\n\n\n\nTable 3.1: Full list of consultations per diagnostic category\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nTable 2. Consultations by ICD-10 neurodevelopmental diagnostic category\n\n\nSorted from most to least frequent and arranged in three column groups.\n\n\n\nGroup 1\n\n\nGroup 2\n\n\nGroup 3\n\n\n\nDiagnostic\nCases\nDiagnostic\nCases\nDiagnostic\nCases\n\n\n\n\nF900\n301,353\nF711\n10,112\nF908\n2,300\n\n\nF809\n228,881\nF799\n9,159\nF729\n2,142\n\n\nF808\n213,846\nF845\n8,193\nF83\n1,877\n\n\nF801\n116,571\nF708\n7,298\nF728\n1,739\n\n\nF819\n110,695\nF709\n7,252\nF844\n1,713\n\n\nF800\n107,053\nF802\n6,760\nF788\n1,360\n\n\nF813\n87,979\nF89\n6,333\nF780\n1,014\n\n\nF840\n87,219\nF719\n5,700\nF781\n1,013\n\n\nF818\n86,717\nF909\n5,640\nF843\n871\n\n\nF848\n27,732\nF721\n5,306\nF842\n850\n\n\nF849\n25,547\nF810\n5,299\nF731\n645\n\n\nF700\n24,236\nF718\n4,458\nF812\n561\n\n\nF82\n24,195\nF798\n4,161\nF803\n538\n\n\nF901\n21,699\nF790\n3,929\nF811\n501\n\n\nF841\n12,797\nF791\n3,356\nF730\n420\n\n\nF710\n12,251\nF789\n2,643\nF738\n410\n\n\nF701\n11,144\nF720\n2,327\nF739\n388\n\n\n\nNote. ICD-10 neurodevelopmental diagnostics, ordered by total number of consultations.\n\n\n\n\n\n\n\n\n\n\n\n\n\n3.2.3.2 Save the Table\nWe export the table to HTML and LaTeX.\n\n\nCode\ngtsave(publication_table_gt,\n       filename = \"Tables/Diagnostic_table.html\")\n\ngtsave(publication_table_gt,\n       filename = \"Tables/Diagnostic_table.tex\")\n\n\nAnd we also create a Word version.\n\n\nCode\nlibrary(flextable)\nlibrary(officer)\n\n# Build a flextable with grouped headers for Word export\npublication_table_ft &lt;- flextable(multi_col_data)\n\npublication_table_ft &lt;- publication_table_ft %&gt;%\n  # First header row: group labels\n  add_header_row(\n    values    = c(\"Group 1\", \"Group 2\", \"Group 3\"),\n    colwidths = c(2, 2, 2)\n  ) %&gt;%\n  # Second header row: column labels\n  set_header_labels(\n    Diagnostic_1 = \"Diagnostic\", Cases_1 = \"Cases\",\n    Diagnostic_2 = \"Diagnostic\", Cases_2 = \"Cases\",\n    Diagnostic_3 = \"Diagnostic\", Cases_3 = \"Cases\"\n  ) %&gt;%\n  theme_apa_flextable() %&gt;%\n  # Center group headers and column labels; bold them\n  align(part = \"header\", align = \"center\") %&gt;%\n  bold(part = \"header\", bold = TRUE) %&gt;%\n  # Right-align numeric columns in the body\n  align(\n    j     = c(\"Cases_1\", \"Cases_2\", \"Cases_3\"),\n    align = \"right\",\n    part  = \"body\"\n  ) %&gt;%\n  # Add a table note at the bottom\n  add_footer_lines(\n    values = \"Note. ICD-10 neurodevelopmental diagnostics, ordered by total number of consultations.\"\n  ) %&gt;%\n  align(part = \"footer\", align = \"left\")\n\n# Export to Word\nsave_as_docx(\n  \"Table 1. Consultations by ICD-10 neurodevelopmental diagnostic category\" = publication_table_ft,\n  path = \"Tables/Diagnostic_table.docx\"\n)",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Diagnostic Frequency Analysis</span>"
    ]
  },
  {
    "objectID": "2_Consultation_DiagnosticFrecuency.html#create-data-subset-for-downstream-analysis",
    "href": "2_Consultation_DiagnosticFrecuency.html#create-data-subset-for-downstream-analysis",
    "title": "3  Diagnostic Frequency Analysis",
    "section": "3.3 Create Data Subset for Downstream Analysis",
    "text": "3.3 Create Data Subset for Downstream Analysis\nBased on the table and plot, we see that “F900”, “F809”, and “F808” are the most frequent diagnostics. For the next part of the analysis (see Deep Dive: Top 3 Diagnostics), we will focus only on these three.\nThis chunk filters the original Neuro_Data to keep only these diagnostics and saves the result as a new CSV file. This new file will be the input for the next notebook.\n\n\nCode\nNeuro_Data_MainDiag &lt;- Neuro_Data  %&gt;%\n  filter(Diagnostic %in% c(\"F900\", \"F809\", \"F808\"))\n\nwrite.csv(Neuro_Data_MainDiag, \"Data_Processed/Neuro_Data_MainDiag.csv\", row.names = FALSE)",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Diagnostic Frequency Analysis</span>"
    ]
  },
  {
    "objectID": "3_Consultation_MostFrequent.html",
    "href": "3_Consultation_MostFrequent.html",
    "title": "4  Frequency of the top 3 Diagnostics",
    "section": "",
    "text": "4.1 Load Project Setup and Data\nThis first chunk sources the _common.R script, which loads all packages, the Plot_theme, and the cleaned Col_map_fixed object.\nIt then loads the subsetted data (Neuro_Data_MainDiag.csv) that was created by the previous notebook (see Diagnostic Frequency Analysis). All analysis in this file will be based on this “Top 3” dataset.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Frequency of the top 3 Diagnostics</span>"
    ]
  },
  {
    "objectID": "3_Consultation_MostFrequent.html#geographical-distribution-of-most-frequent-cases",
    "href": "3_Consultation_MostFrequent.html#geographical-distribution-of-most-frequent-cases",
    "title": "4  Frequency of the top 3 Diagnostics",
    "section": "4.2 Geographical Distribution of Most Frequent Cases",
    "text": "4.2 Geographical Distribution of Most Frequent Cases\nWe examine how the three most common neurodevelopmental diagnoses are distributed across Colombian departments. This analysis focuses on median consultation rates per 10,000 inhabitants, which allows us to compare regions while minimizing the influence of extreme values.\n\n4.2.1 Data Preparation\nWe begin by summarizing the consultation frequency for each of the three focal diagnostic categories within every department. The data are grouped by Department and Diagnostic, and we compute the median number of consultations per 10,000 inhabitants. This measure gives a stable central estimate for each diagnostic–department combination.\n\n\nCode\nSummary_Common_Geography &lt;- Neuro_Data_MainDiag %&gt;%\n  group_by(Department, Diagnostic) %&gt;%\n  summarise(\n    MedianCases = median(Diagnostics_per_tenthousand, na.rm = TRUE),\n  ) %&gt;%\n  ungroup()\n\n\n`summarise()` has grouped output by 'Department'. You can override using the\n`.groups` argument.\n\n\n\n\n4.2.2 Results Table\nTo facilitate comparison across regions, we reshape the dataset so that each diagnostic category occupies its own column. The resulting wide-format table includes the median frequency for each diagnostic, along with a Total column that sums all three (“F808”, “F809”, “F900”). Departments are then ordered from highest to lowest total case burden.\n\n\nCode\n# --- 1. Pivot the data to wide format ---\nwide_geo_summary &lt;- Summary_Common_Geography %&gt;%\n  pivot_wider(\n    names_from = Diagnostic,\n    values_from = MedianCases,\n    values_fill = 0\n  ) %&gt;%\n  mutate(Total_All_Cases = rowSums(across(where(is.numeric)))) %&gt;%\n  arrange(desc(Total_All_Cases))\n\n# --- 2. Create APA-style gt table ---\ngeo_table &lt;- wide_geo_summary %&gt;%\n  gt() %&gt;%\n  tab_header(\n    title = md(\"**Table 2. Median neurodevelopmental consultations per 10.000 inhabitants**\")\n  ) %&gt;%\n  cols_label(\n    Department      = \"Department\",\n    Total_All_Cases = \"Total\"\n  ) %&gt;%\n  fmt_number(\n    columns = where(is.numeric),\n    use_seps = TRUE,\n    decimals = 0\n  ) %&gt;%\n  # APA 7 styling\n  theme_apa_gt() %&gt;%\n  tab_source_note(\n    source_note = \"Median number of consultations per 10,000 inhabitants, grouped by department and diagnostic category.\"\n  )\n\n# --- 3. Save files ---\ngtsave(geo_table, filename = \"Tables/Geo_Summary.html\")\ngtsave(geo_table, filename = \"Tables/Geo_Summary.tex\")\n\ngeo_table\n\n\n\n\nTable 4.1: Total Cases by Department and Main Diagnostic\n\n\n\n\n\n\n\n\n\nTable 2. Median neurodevelopmental consultations per 10.000 inhabitants\n\n\nDepartment\nF808\nF809\nF900\nTotal\n\n\n\n\nNarino\n139\n128\n142\n408\n\n\nBoyaca\n128\n119\n84\n331\n\n\nSantander\n79\n84\n97\n260\n\n\nCaldas\n70\n74\n93\n237\n\n\nCundinamarca\n75\n82\n70\n227\n\n\nTolima\n75\n76\n64\n215\n\n\nQuindio\n58\n51\n103\n212\n\n\nPutumayo\n68\n74\n50\n192\n\n\nRisaralda\n51\n53\n85\n189\n\n\nCasanare\n55\n58\n61\n174\n\n\nSucre\n52\n53\n69\n174\n\n\nNorte de Santander\n57\n60\n56\n173\n\n\nChoco\n53\n54\n65\n172\n\n\nArchipielago de San Andres, Providencia Y Santa Catalina\n48\n47\n70\n166\n\n\nHuila\n52\n63\n46\n161\n\n\nCauca\n60\n59\n40\n159\n\n\nBolivar\n47\n44\n67\n158\n\n\nAntioquia\n43\n38\n76\n157\n\n\nCaqueta\n53\n56\n46\n155\n\n\nValle del Cauca\n48\n51\n45\n144\n\n\nAtlantico\n39\n38\n65\n142\n\n\nMeta\n48\n51\n38\n136\n\n\nVichada\n20\n46\n50\n116\n\n\nArauca\n41\n40\n34\n115\n\n\nCesar\n37\n41\n37\n115\n\n\nGuaviare\n36\n50\n18\n103\n\n\nCordoba\n29\n31\n36\n96\n\n\nMagdalena\n34\n31\n31\n96\n\n\nLa Guajira\n23\n33\n31\n87\n\n\nAmazonas\n33\n32\n18\n84\n\n\nGuainia\n26\n27\n26\n79\n\n\nVaupes\n22\n21\n21\n64\n\n\n\nMedian number of consultations per 10,000 inhabitants, grouped by department and diagnostic category.\n\n\n\n\n\n\n\n\n\n\n\nAfter summarizing the median burden of the three most frequent neurodevelopmental diagnostic categories (F808, F809, F900) across all departments in Table 4.1, we identify the ten departments with the highest combined consultation rates and extract them using slice_max() on the total median burden.\n\n\nCode\nlibrary(gt)\n\n# --- 1. Select the top 10 departments by total burden ---\ngeo_top10 &lt;- wide_geo_summary %&gt;%\n  slice_max(Total_All_Cases, n = 10)\n\n# --- 2. Create APA-style gt table ---\ngeo_top10_gt &lt;- geo_top10 %&gt;%\n  gt() %&gt;%\n  tab_header(\n    title = md(\"**Table X. Top 10 departments by median neurodevelopmental consultations per 10,000 inhabitants**\"),\n    subtitle = \"Values correspond to median consultation rates for the three most frequent diagnostic categories.\"\n  ) %&gt;%\n  cols_label(\n    Department      = \"Department\",\n    F808            = \"F808\",\n    F809            = \"F809\",\n    F900            = \"F900\",\n    Total_All_Cases = \"Total\"\n  ) %&gt;%\n  fmt_number(\n    columns  = where(is.numeric),\n    use_seps = TRUE,\n    decimals = 0\n  ) %&gt;%\n  theme_apa_gt() %&gt;%\n  tab_source_note(\n    source_note = \"Note. Departments are ordered by the total median burden across the three most frequent diagnostic categories.\"\n  )\n\ngeo_top10_gt\n# --- 3. Export gt table to HTML and LaTeX ---\ngtsave(geo_top10_gt, filename = \"Tables/Geo_Top10.html\")\ngtsave(geo_top10_gt, filename = \"Tables/Geo_Top10.tex\")\n\n\n\n\nTable 4.2: Top 10 departments by median neurodevelopmental consultations\n\n\n\n\n\n\n\n\n\nTable X. Top 10 departments by median neurodevelopmental consultations per 10,000 inhabitants\n\n\nValues correspond to median consultation rates for the three most frequent diagnostic categories.\n\n\nDepartment\nF808\nF809\nF900\nTotal\n\n\n\n\nNarino\n139\n128\n142\n408\n\n\nBoyaca\n128\n119\n84\n331\n\n\nSantander\n79\n84\n97\n260\n\n\nCaldas\n70\n74\n93\n237\n\n\nCundinamarca\n75\n82\n70\n227\n\n\nTolima\n75\n76\n64\n215\n\n\nQuindio\n58\n51\n103\n212\n\n\nPutumayo\n68\n74\n50\n192\n\n\nRisaralda\n51\n53\n85\n189\n\n\nCasanare\n55\n58\n61\n174\n\n\nSucre\n52\n53\n69\n174\n\n\n\nNote. Departments are ordered by the total median burden across the three most frequent diagnostic categories.\n\n\n\n\n\n\n\n\n\n\n\nThe table presents the median number of consultations per 10,000 inhabitants for each of the three diagnostic groups, along with a total column representing the combined burden. This structure highlights the departments where neurodevelopmental consultations occur most frequently and provides a clear comparative overview.\nWe exported the table to HTML and LaTeX via gt, and then generate a version for Microsoft Word using flextable with borders and layout:\n\n\n\nTable 4.3\n\n\n\nCode\nlibrary(flextable)\nlibrary(officer)\n\ngeo_top10_ft &lt;- flextable(geo_top10)\n\ngeo_top10_ft &lt;- geo_top10_ft %&gt;%\n  # set simple header labels\n  set_header_labels(\n    Department      = \"Department\",\n    F808            = \"F808\",\n    F809            = \"F809\",\n    F900            = \"F900\",\n    Total_All_Cases = \"Total\"\n  ) %&gt;%\n  theme_apa_flextable() %&gt;%\n  # center header, bold\n  align(part = \"header\", align = \"center\") %&gt;%\n  bold(part = \"header\", bold = TRUE) %&gt;%\n  # right-align numeric columns\n  align(\n    j     = c(\"F808\", \"F809\", \"F900\", \"Total_All_Cases\"),\n    align = \"right\",\n    part  = \"body\"\n  ) %&gt;%\n  # add table note\n  add_footer_lines(\n    values = \"Note. Departments are ordered by the total median burden across the three most frequent diagnostic categories.\"\n  ) %&gt;%\n  align(part = \"footer\", align = \"left\")\n\n# Export to Word\nsave_as_docx(\n  \"Table X. Top 10 departments by median neurodevelopmental consultations per 10,000 inhabitants\" = geo_top10_ft,\n  path = \"Tables/Geo_Top10.docx\"\n)\n\n\n\n\n\n\n4.2.3 Data Visualization (Faceted Map)\nWe join our Summary_Common_Geography with the Col_map_fixed object (from _common.R). We then use facet_wrap(~ Diagnostic) to create a “small multiple” map, showing the geographic distribution for each of the three diagnostics side-by-side.\nWe next create a visualization for the three most common neurodevelopmental diagnostic categories (F808, F809, and F900). We join the calculated rate per 10,000 inhabitants with the national shapefile and generate a faceted map to make regional differences easier to compare. Departments with lower consultation rates appear in light colors (yellow–green), while those with higher rates appear in darker tones.\n\n\nCode\n# Join map data with top-3 diagnostic data\nMap_df &lt;- Col_map_fixed %&gt;%\n  left_join(Summary_Common_Geography, by = \"Department\")\n\n# We exclude NAs (departments with no cases for these diagnostics)\nMap_df &lt;- Map_df %&gt;%\n  filter(!is.na(MedianCases))\n\n# Create the faceted map\nCases_Diagnostic_map &lt;- ggplot(Map_df) +\n  geom_sf(aes(fill = MedianCases), colour = \"white\", size = 0.2) +\n  scale_fill_viridis_c(\n    option    = \"viridis\",\n    direction = -1,\n    name      = \"Median number of consultations \\nper 10.000 (reference population)\",\n    guide = guide_colorbar(\n      barwidth        = unit(10, \"cm\"),  \n      barheight       = unit(0.5, \"cm\")   \n    )\n  ) +\n  facet_wrap(~ Diagnostic) +\n  labs(title = \"Consultations per department (2016-2022)\") +\n  theme_minimal() +\n  Plot_theme +\n  theme(\n    plot.title = element_text(size=18, face=\"bold\", vjust = 2, hjust = 0.5),\n    legend.title = element_text(colour=\"black\", face=\"bold\", size=18),\n    axis.text.y = element_blank(),\n    axis.text.x = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.ticks.x = element_blank(),\n    legend.position = \"bottom\",\n    legend.direction = \"horizontal\",\n    strip.text = element_text(size = 18)\n  ) \n\nggsave(Cases_Diagnostic_map,\n       filename = \"Plots/Cases_Diagnostic_map.png\",\n       width    = 40, \n       height   = 20, \n       units    = \"cm\")\n\nCases_Diagnostic_map\n\n\n\n\n\n\n\n\nFigure 4.1: Distribution of neurodevelopmental diagnostics per department and capital city status\n\n\n\n\n\nThe resulting Figure 4.1 displays three side-by-side maps covering the entire period (2016–2022), providing an overview of which regions report the highest and lowest median consultation intensity for each diagnostic code.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Frequency of the top 3 Diagnostics</span>"
    ]
  },
  {
    "objectID": "3_Consultation_MostFrequent.html#distribution-per-diagnostic-and-sex",
    "href": "3_Consultation_MostFrequent.html#distribution-per-diagnostic-and-sex",
    "title": "4  Frequency of the top 3 Diagnostics",
    "section": "4.3 Distribution per Diagnostic and Sex",
    "text": "4.3 Distribution per Diagnostic and Sex\nIn this section, we examine whether the three most frequent diagnostic categories (F808, F809, and F900) show different consultation patterns for men and women across Colombian departments. We summarize the data by computing the median number of consultations per 10,000 inhabitants for each combination of department, diagnostic category, and biological sex.\n\n4.3.1 Data Preparation\nTo prepare the data, we group observations by Department, Diagnostic, and Sex, and compute two quantities for each combination:\n\nThe median consultation rate per 10,000 inhabitants (MedianCases)\nThe total population represented (Total_Population), aggregated across all years\n\n\n\nCode\nSummary_Diagnostic_Sex &lt;- Neuro_Data_MainDiag %&gt;%\n  group_by(Department, Diagnostic, Sex) %&gt;%\n  summarise(MedianCases = median(Diagnostics_per_tenthousand, na.rm = TRUE),\n            Total_Population = sum(Population, na.rm = TRUE)) %&gt;%\n  ungroup() \n\n\n`summarise()` has grouped output by 'Department', 'Diagnostic'. You can\noverride using the `.groups` argument.\n\n\nCode\nSummary_Diagnostic_Sex\n\n\n# A tibble: 192 × 5\n   Department Diagnostic Sex   MedianCases Total_Population\n   &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;       &lt;dbl&gt;            &lt;int&gt;\n 1 Amazonas   F808       Men          34              33115\n 2 Amazonas   F808       Women        18              26885\n 3 Amazonas   F809       Men          34              35787\n 4 Amazonas   F809       Women        18              20988\n 5 Amazonas   F900       Men          18              14201\n 6 Amazonas   F900       Women        18               2250\n 7 Antioquia  F808       Men          51            3128599\n 8 Antioquia  F808       Women        32            2450118\n 9 Antioquia  F809       Men          48            2929082\n10 Antioquia  F809       Women        31.5          2298031\n# ℹ 182 more rows\n\n\n\n\n4.3.2 Summary Table (Sex & Diagnostic)\nTo quantify these patterns, we compute descriptive statistics—N, Mean, Median, SD, Min, Max—for each diagnostic category and sex. These values summarize the department-level distribution of consultation rates and reinforce the visualization.\n\n\nCode\nsummary_table_sex &lt;- Summary_Diagnostic_Sex %&gt;%\n  group_by(Diagnostic, Sex) %&gt;%\n  summarize(\n    N = n(),\n    Mean = round(mean(MedianCases, na.rm = TRUE)),\n    Median = round(median(MedianCases, na.rm = TRUE)),\n    SD = round(sd(MedianCases, na.rm = TRUE)),\n    Min = round(min(MedianCases, na.rm = TRUE)),\n    Max = round(max(MedianCases, na.rm = TRUE)),\n    .groups = 'drop'\n  )\n\n\nWe see that across all three diagnostics, men show higher means and medians. The differences between sexes are largest for F809 and F900, where medians differ by about 20–25 consultations per 10,000 inhabitants. Standard deviations are consistently larger for men, suggesting more heterogeneity across departments.\nThe summary data is formatted with gt. We use gt(groupname_col = \"Diagnostic\") to create a clean, hierarchical table grouped by diagnostic, which is ideal for this type of summary. We also format the numeric columns to 0 decimal places, as they are rounded integers.\n\n\nCode\n# Create the gt table\npublication_table_sex &lt;- summary_table_sex %&gt;%\n  gt(groupname_col = \"Diagnostic\") %&gt;% \n  \n  cols_label(\n    Sex = \"Sex\",\n    N = \"N\",\n    Mean = \"Mean\",\n    Median = \"Median\",\n    SD = \"SD\",\n    Min = \"Min\",\n    Max = \"Max\"\n  ) %&gt;%\n  \n  # Format numbers with 0 decimals\n  fmt_number(\n    columns = c(N, Mean, Median, SD, Min, Max),\n    use_seps = TRUE,\n    decimals = 0\n  ) %&gt;%\n  \n  # --- APA 7 STYLING ---\n  theme_apa_gt()\n\n# Save the table\ngtsave(publication_table_sex,\n       filename = \"Tables/Diagnostic_Sex_Summary.html\")\ngtsave(publication_table_sex,\n       filename = \"Tables/Diagnostic_Sex_Summary.tex\")\n\npublication_table_sex\n\n\n\n\nTable 4.4: Descriptive Statistics for Consultations by Diagnostic and Sex\n\n\n\n\n\n\n\n\n\nSex\nN\nMean\nMedian\nSD\nMin\nMax\n\n\n\n\nF808\n\n\nMen\n32\n61\n57\n30\n22\n156\n\n\nWomen\n32\n41\n36\n20\n15\n116\n\n\nF809\n\n\nMen\n32\n63\n60\n27\n21\n139\n\n\nWomen\n32\n43\n40\n20\n10\n105\n\n\nF900\n\n\nMen\n32\n68\n59\n35\n18\n156\n\n\nWomen\n32\n43\n44\n21\n17\n120\n\n\n\n\n\n\n\n\n\n\n\n\n4.3.3 Data Visualization (Ridge-Density Plot)\nTo visualize the distribution of consultation rates across departments, we generate a ridge-density plot for each diagnostic category. By overlaying the densities for men and women, we compare not only central tendencies but also variability and the presence of extreme values.\n\n\nCode\nDiagnostic_Sex_fig &lt;- Summary_Diagnostic_Sex %&gt;%\n  ggplot(aes(x=MedianCases, y=Diagnostic, color = Sex, fill = Sex)) +\n    geom_density_ridges2(alpha = 0.3) +\n    \n    scale_fill_manual(values = c(\"Men\" = \"#00BFC4\", \"Women\" = \"#F8766D\")) +\n    scale_color_manual(values = c(\"Men\" = \"#00BFC4\", \"Women\" = \"#F8766D\")) +\n    # ------------------------------------\n\n    ggtitle(\"\") +\n    #xlim(0, 2000) +\n  labs(y = \"ICD-10 neurodevelopmental diagnostics\",\n       x = \"Median number of consultations \\nper 10.000 (reference population)\") +\n  Plot_theme +\n  theme (legend.position = c(0.8, 0.9),\n         legend.direction = \"vertical\") \n\nggsave(Diagnostic_Sex_fig,\n       filename = \"Plots/Diagnostic_Sex_fig.png\",\n       width    = 15, \n       height   = 15, \n       units    = \"cm\")\n\n\nPicking joint bandwidth of 9.56\n\n\nCode\nDiagnostic_Sex_fig\n\n\nPicking joint bandwidth of 9.56\n\n\n\n\n\n\n\n\nFigure 4.2: Distribution of neurodevelopmental diagnostics per biological sex\n\n\n\n\n\nThe Figure 4.2 shows clear and systematic sex differences across all three diagnostic groups:\n\nMen consistently present higher consultation rates than women for F808, F809, and F900.\nThe shape of the distributions indicates greater variability among men, particularly for F809 and F900.\nWomen generally show more concentrated distributions with lower medians and narrower ranges.\n\n\n\n4.3.4 Statistical Model\nWe now move from descriptive summaries to a hierarchical regression model that tests how consultation rates vary jointly by diagnostic category and biological sex while accounting for geographical structure.\n\n4.3.4.1 Data Preparation\nFor the modeling step, we treat each city as an individual observation. We therefore summarize the data by city, department, diagnostic category, and sex, and compute the mean number of consultations per 10,000 inhabitants (MeanCases) for each combination. This gives us a dataset in which every row corresponds to a specific city–department–diagnostic–sex cell, which we then use as input for the model.\n\n\nCode\nSummary_Diagnostic_Sex_2 &lt;- Neuro_Data_MainDiag %&gt;%\n  group_by(City, Department, Diagnostic, Sex) %&gt;%\n  summarise(MeanCases = mean(Diagnostics_per_tenthousand, na.rm = TRUE)) %&gt;%\n  ungroup() \n\n\n`summarise()` has grouped output by 'City', 'Department', 'Diagnostic'. You can\noverride using the `.groups` argument.\n\n\nCode\nSummary_Diagnostic_Sex_2\n\n\n# A tibble: 6,091 × 5\n   City      Department         Diagnostic Sex   MeanCases\n   &lt;chr&gt;     &lt;chr&gt;              &lt;chr&gt;      &lt;chr&gt;     &lt;dbl&gt;\n 1 Abejorral Antioquia          F808       Men        99.6\n 2 Abejorral Antioquia          F808       Women      74.6\n 3 Abejorral Antioquia          F809       Men        97.9\n 4 Abejorral Antioquia          F809       Women      82.4\n 5 Abejorral Antioquia          F900       Men        94.2\n 6 Abejorral Antioquia          F900       Women      76.8\n 7 Abrego    Norte de Santander F808       Men        56.4\n 8 Abrego    Norte de Santander F808       Women      40.3\n 9 Abrego    Norte de Santander F809       Men        56.4\n10 Abrego    Norte de Santander F809       Women      39.9\n# ℹ 6,081 more rows\n\n\n\n\n4.3.4.2 Model Specification\nWe use the brms package to fit a Bayesian multilevel model with a Student-t likelihood. The outcome is the mean number of consultations per 10,000 inhabitants (MeanCases). At the fixed-effect level, we include sex, diagnostic category, and their interaction (Sex * Diagnostic). To account for residual geographical differences between departments, we add a varying intercept for department (1 | Department).\nThis structure allows us to estimate:\n\nthe overall differences between men and women,\nhow those differences change across the three diagnostic categories, and\nhow much consultation intensity varies between departments after controlling for sex and diagnosis.\n\nWe use weakly informative priors (the brms defaults for the Student-t family), run four Markov chains with 5,000 iterations each (2,500 warm-up), and increase adapt_delta and max_treedepth to ensure stable sampling.\n\n\n4.3.4.3 Fit the Model\nWe model the mean number of consultations per 10,000 inhabitants as:\n\\[\n\\text{MeanCases}_{i j k s}\n= \\beta_0\n+ \\beta_{\\text{Sex},s}\n+ \\beta_{\\text{Diag},k}\n+ \\beta_{\\text{Sex}\\times\\text{Diag}, s k}\n+ u_j\n+ \\varepsilon_{i j k s},\n\\]\nwhere:\n\n\\(i\\) indexes cities,\n\\(j\\) indexes departments,\n\\(k\\) indexes diagnostic categories (\\(k \\in \\{\\text{F808}, \\text{F809}, \\text{F900}\\}\\)),\n\\(s\\) indexes biological sex (\\(s \\in \\{\\text{Men}, \\text{Women}\\}\\)).\n\nWe use treatment coding so that:\n\n\\(s = \\text{Men}\\) and \\(k = \\text{F808}\\) define the reference group,\n\\(\\beta_0\\) is the expected mean consultation rate for men with diagnosis F808,\n\\(\\beta_{\\text{Sex},\\text{Women}}\\) is the average difference between women and men for F808,\n\\(\\beta_{\\text{Diag},\\text{F809}}\\) and \\(\\beta_{\\text{Diag},\\text{F900}}\\) are the average differences between F809 / F900 and F808 for men,\n\\(\\beta_{\\text{Sex}\\times\\text{Diag},\\text{Women},k}\\) are the additional sex differences specific to each diagnostic category (i.e., how the women–men contrast changes for F809 or F900 relative to F808).\n\nThe department-level random intercepts are:\n\\[\nu_j \\sim \\mathcal{N}(0, \\sigma_{\\text{Dept}}^2),\n\\]\nand the observation-level errors follow a Student-t distribution:\n\\[\n\\varepsilon_{i j k s} \\sim t_\\nu(0, \\sigma),\n\\]\nwith degrees of freedom \\(\\nu\\) and scale parameter \\(\\sigma\\) estimated from the data.\n\n\nCode\n# Model formula\nCases_Diagnostic_Sex_Mdl1 &lt;- bf(MeanCases ~ Sex * Diagnostic + (1 | Department))\n               \n# List priors and variables\nget_prior(Cases_Diagnostic_Sex_Mdl1, Summary_Diagnostic_Sex_2, family = student)\n\n# Fit model 1\nCases_Diagnostic_Sex_Fit1 &lt;- \n  brm(\n    family  = student,\n    data    = Summary_Diagnostic_Sex_2,\n    formula = Cases_Diagnostic_Sex_Mdl1,\n    chains  = 4,\n    cores   = 4,\n    warmup  = 2500, \n    iter    = 5000, \n    seed    = 8807,\n    control = list(adapt_delta = 0.99, max_treedepth = 15),\n    file    = \"Models/Cases_Diagnostic_Sex_Fit1.rds\",\n    file_refit = \"never\")\n\n\n\n\n4.3.4.4 Results\n\n\nCode\ntbl_cases_sex &lt;- tbl_regression(\n  x            = Cases_Diagnostic_Sex_Fit1,\n  intercept    = TRUE,\n  estimate_fun = ~ style_sigfig(., digits = 2),\n  conf.level   = 0.95\n) %&gt;%\n  modify_header(\n    label    ~ \"**Predictor**\",\n    estimate ~ \"**Estimate**\",\n    ci       ~ \"**95% CI**\"\n  ) %&gt;%\n  bold_labels() %&gt;%\n  modify_caption(\n    \"**Table 1. Effect of biological sex on neurodevelopmental consultation rates**\"\n  )\n\ntbl_cases_sex \n\n\n\n\nTable 4.5: Table 1. Effect of biological sex on neurodevelopmental consultation rates\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPredictor\nEstimate\n95% CI\n95% CI\n\n\n\n\ncond\n\n\n(Intercept)\n91\n77, 106\n77, 106\n\n\nSex\n\n\n\n\n\n\n\n\n    SexWomen\n-12\n-17, -6.9\n-17, -6.9\n\n\nDiagnostic\n\n\n\n\n\n\n\n\n    DiagnosticF809\n1.1\n-4.2, 6.4\n-4.2, 6.4\n\n\n    DiagnosticF900\n2.2\n-3.2, 7.7\n-3.2, 7.7\n\n\nDepartment\n\n\n\n\n\n\n\n\n    SexWomen:DiagnosticF809\n-1.4\n-8.9, 6.1\n-8.9, 6.1\n\n\n    SexWomen:DiagnosticF900\n-4.0\n-12, 3.6\n-12, 3.6\n\n\n\nAbbreviation: CI = Credible Interval\n\n\n\n\n\n\n\n\n\n\n\nThe intercept of the model corresponds to men diagnosed with F808, who show an estimated mean of about 91 consultations per 10,000 inhabitants. This provides a baseline against which we interpret the remaining effects. The coefficient for SexWomen is strongly negative (around −12), with a 95% credible interval that excludes zero, meaning that, for F808, women show substantially fewer consultations than men on average.\nFor men, F900 is associated with higher consultation rates than F808, with posterior estimates suggesting an increase of roughly 13 consultations per 10,000 inhabitants and a credible interval that lies entirely above zero. In contrast, the difference between F809 and F808 for men is small and uncertain, with a credible interval that spans zero. The interaction terms indicate that the sex difference for F809 and F900 may be slightly larger (more negative) than for F808, but the uncertainty is wide and the credible intervals include zero, so we treat these diagnosis-specific modifications as weak at best.\nThe random-effect standard deviation for departments (around 40) highlights substantial variability in consultation intensity across regions after adjusting for sex and diagnosis, while the residual standard deviation (around 47) reflects remaining city-level variability and measurement noise.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Frequency of the top 3 Diagnostics</span>"
    ]
  },
  {
    "objectID": "3_Consultation_MostFrequent.html#most-frequent-per-year-and-sex",
    "href": "3_Consultation_MostFrequent.html#most-frequent-per-year-and-sex",
    "title": "4  Frequency of the top 3 Diagnostics",
    "section": "4.4 Most Frequent per Year and Sex",
    "text": "4.4 Most Frequent per Year and Sex\nWe now examine how the three most frequent diagnostic categories evolve over time for men and women. By combining Year, Sex, and Diagnostic, we obtain a compact view of temporal trends in consultation intensity.\n\n4.4.1 Data Preparation\nWe first summarize the data by Year, Sex, and Diagnostic. For every combination of these three variables, we compute the median number of consultations per 10,000 inhabitants (MedianCases). This gives us a balanced panel where each row corresponds to a specific year–sex–diagnostic cell, and the outcome is a robust central estimate that is less sensitive to extreme values than the mean.\nThe resulting Summary_Main_YearSex table serves as the basis for the crosstab and for any subsequent visualizations of time trends.\n\n\nCode\nSummary_Main_YearSex &lt;- Neuro_Data_MainDiag %&gt;%\n  group_by(Year, Sex, Diagnostic) %&gt;%\n  summarise(MedianCases = median(Diagnostics_per_tenthousand, na.rm = TRUE)) %&gt;%\n  ungroup()\n\n\n`summarise()` has grouped output by 'Year', 'Sex'. You can override using the\n`.groups` argument.\n\n\nCode\nSummary_Main_YearSex\n\n\n# A tibble: 42 × 4\n    Year Sex   Diagnostic MedianCases\n   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;            &lt;dbl&gt;\n 1  2016 Men   F808                52\n 2  2016 Men   F809                54\n 3  2016 Men   F900                60\n 4  2016 Women F808                34\n 5  2016 Women F809                38\n 6  2016 Women F900                36\n 7  2017 Men   F808                60\n 8  2017 Men   F809                59\n 9  2017 Men   F900                68\n10  2017 Women F808                36\n# ℹ 32 more rows\n\n\n\n\n4.4.2 Results Table\nBecause we are working with three variables (Year, Sex, Diagnostic), a long table would be hard to read. Instead, we reorganize the data into a wide-format crosstab where:\n\nrows are defined by Year and Sex, and\ncolumns correspond to the three diagnostic codes (F808, F809, F900).\n\nWe obtain this layout by applying pivot_wider() to Summary_Main_YearSex, using Diagnostic as the source of new column names and MedianCases as the cell values. We then order the rows by Year and Sex so that time flows from top to bottom and men/women appear consistently within each year.\nFinally, we format the table with gt using APA-style options. We label the Year and Sex columns, format all numeric diagnostic columns as whole numbers, and remove internal vertical lines to enhance readability.\n\n\nCode\nlibrary(dplyr)\nlibrary(tidyr)  \nlibrary(gt)\n\n# --- 2. Pivot 'Diagnostic' to be wide ---\nwide_diag_summary &lt;- Summary_Main_YearSex %&gt;%\n  pivot_wider(\n    names_from = Diagnostic,\n    values_from = MedianCases,\n    values_fill = 0\n  ) %&gt;%\n  arrange(Year, Sex) \n\n# --- 3. Create the APA 7 gt table ---\ndiag_table &lt;- wide_diag_summary %&gt;%\n  gt() %&gt;%\n  \n  cols_label(\n    Year = \"Year\",\n    Sex = \"Sex\"\n  ) %&gt;%\n  \n  # Format all numeric columns *except* 'Year' with commas\n  fmt_number(\n    columns = where(is.numeric) & !matches(\"^Year$\"),\n    use_seps = TRUE,\n    decimals = 0\n  ) %&gt;%\n  \n  # --- THIS IS THE FIX ---\n  # Format the 'Year' column *without* commas and *with 0 decimals*\n  fmt_number(\n    columns = Year,\n    use_seps = FALSE,\n    decimals = 0 \n  ) %&gt;%\n\n  # --- APA 7 STYLING ---\n  theme_apa_gt()\n\n# --- 4. Save the table files ---\ngtsave(diag_table,\n       filename = \"Tables/YearSexDiag_Wide.html\")\n\ngtsave(diag_table,\n       filename = \"Tables/YearSexDiag_Wide.tex\")\n\n# --- 5. Display the table ---\ndiag_table\n\n\n\n\nTable 4.6: Total Cases by Year, Sex, and Main Diagnostic\n\n\n\n\n\n\n\n\n\nYear\nSex\nF808\nF809\nF900\n\n\n\n\n2016\nMen\n52\n54\n60\n\n\n2016\nWomen\n34\n38\n36\n\n\n2017\nMen\n60\n59\n68\n\n\n2017\nWomen\n36\n42\n45\n\n\n2018\nMen\n68\n65\n84\n\n\n2018\nWomen\n46\n45\n49\n\n\n2019\nMen\n74\n76\n97\n\n\n2019\nWomen\n48\n50\n60\n\n\n2020\nMen\n55\n56\n69\n\n\n2020\nWomen\n36\n39\n42\n\n\n2021\nMen\n70\n72\n67\n\n\n2021\nWomen\n48\n49\n43\n\n\n2022\nMen\n74\n77\n83\n\n\n2022\nWomen\n49\n51\n52\n\n\n\n\n\n\n\n\n\n\n\n\n4.4.3 Data Visualization (Faceted Line Plot)\nWe visualize these temporal patterns using a faceted line plot. The x-axis represents calendar year, and the y-axis shows the median number of consultations per 10,000 inhabitants. Each diagnostic category (F808, F809, F900) is plotted as a separate colored line with points marking annual values. The plot is faceted by sex (facet_wrap(~ Sex)), producing one panel for men and one for women.\n\n\nCode\nCases_Year_fig &lt;- Summary_Main_YearSex %&gt;%\n  ggplot( aes(x= Year, y= MedianCases, colour = Diagnostic)) +\n    geom_line(size= 1) +\n    geom_point(shape=21, size=4) +\n    scale_y_continuous(name = \"Median number of consultations \\n per 10.000 (reference population)\",\n                     labels = scales::label_number(scale_cut = scales::cut_short_scale())) +\n    ggtitle(\"\") +\n    labs(x = \"Year\") +\n   \n    facet_wrap(~ Sex, ncol = 1) +\n  \n    Plot_theme +\n  \n    theme(\n      legend.position = c(0.9, 0.3),\n  # Style the facet labels to make them clear\n    strip.text = element_text(size = 12, face = \"bold\", hjust = 0.5),\n    strip.background = element_rect(fill = \"grey90\", color = NA)\n  ) \n\n\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nℹ Please use `linewidth` instead.\n\n\nCode\nggsave(Cases_Year_fig,\n       filename = \"Plots/Cases_Year_fig.png\",\n       width    = 14, \n       height   = 13, \n       units    = \"cm\")\n\nCases_Year_fig \n\n\n\n\n\n\n\n\nFigure 4.3: Distribution of neurodevelopmental disorder cases per year",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Frequency of the top 3 Diagnostics</span>"
    ]
  },
  {
    "objectID": "3_Consultation_MostFrequent.html#cases-by-sex-and-age",
    "href": "3_Consultation_MostFrequent.html#cases-by-sex-and-age",
    "title": "4  Frequency of the top 3 Diagnostics",
    "section": "4.5 Cases by Sex and Age",
    "text": "4.5 Cases by Sex and Age\nWe first summarize the dataset by age and biological sex. For each age–sex combination, we compute the median number of neurodevelopmental consultations per 10,000 inhabitants and the total population size contributing to that value.\n\n4.5.1 Data Preparation\nWe group the data by Age and Sex, summarizing both Total_Cases and Total_Population.\n\n\nCode\nSummary_Age_Sex &lt;- Neuro_Data_MainDiag %&gt;%\n  group_by(Age, Sex) %&gt;%\n  summarise(MedianCases = median(Diagnostics_per_tenthousand, na.rm = TRUE),\n            Total_Population = sum(Population, na.rm = TRUE)) %&gt;%\n  ungroup()\n\n\n`summarise()` has grouped output by 'Age'. You can override using the `.groups`\nargument.\n\n\n\n\n4.5.2 Results Table\nTo present the results clearly, we reshape the data so that “Men” and “Women” appear as column groups. Each group contains two variables—median consultations and population size—making comparison across ages straightforward.\n\n\nCode\nlibrary(dplyr)\nlibrary(tidyr)  # Needed for pivot_wider\nlibrary(gt)\n\n# --- 2. Pivot 'Sex' to be wide ---\n# This creates new columns like \"Total_Cases_Men\", \"Total_Population_Men\", etc.\nwide_age_sex_summary &lt;- Summary_Age_Sex %&gt;%\n  pivot_wider(\n    names_from = Sex,\n    values_from = c(MedianCases, Total_Population),\n    values_fill = 0\n  ) %&gt;%\n  arrange(Age) # Sort by Age\n\n# --- 3. Create the APA 7 gt table ---\nagesex_table &lt;- wide_age_sex_summary %&gt;%\n  gt() %&gt;%\n  \n  # --- Create spanner headers for \"Men\" and \"Women\" ---\n  # Assumes your 'Sex' column has \"Men\" and \"Women\". Adjust if needed.\n  tab_spanner(\n    label = \"Men\",\n    columns = c(MedianCases_Men, Total_Population_Men)\n  ) %&gt;%\n  tab_spanner(\n    label = \"Women\",\n    columns = c(MedianCases_Women, Total_Population_Women)\n  ) %&gt;%\n  \n  # Relabel columns under the spanners\n  cols_label(\n    Age = \"Age Group\",\n    MedianCases_Men = \"Consultations\",\n    Total_Population_Men = \"Population\",\n    MedianCases_Women = \"Consultations\",\n    Total_Population_Women = \"Population\"\n  ) %&gt;%\n  \n  # Format all numeric columns *except* 'Age' with commas\n  fmt_number(\n    columns = where(is.numeric) & !matches(\"^Age$\"),\n    use_seps = TRUE,\n    decimals = 0\n  ) %&gt;%\n\n  # --- APA 7 STYLING ---\n  theme_apa_gt()\n\n# --- 4. Save the table files ---\ngtsave(agesex_table,\n       filename = \"Plots/AgeSex_Summary.html\")\n\ngtsave(agesex_table,\n       filename = \"Plots/AgeSex_Summary.tex\")\n\n# --- 5. Display the table ---\nagesex_table\n\n\n\n\nTable 4.7: Total Cases and Population by Age Group and Sex\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nAge Group\n\nMen\n\n\nWomen\n\n\n\nConsultations\nPopulation\nConsultations\nPopulation\n\n\n\n\n0\n18\n3,012,163\n14\n2,499,885\n\n\n1\n41\n4,583,491\n28\n3,820,145\n\n\n2\n74\n5,575,748\n48\n4,640,155\n\n\n3\n84\n5,993,173\n52\n4,996,775\n\n\n4\n87\n6,580,896\n55\n5,454,308\n\n\n5\n85\n7,078,441\n54\n5,871,140\n\n\n6\n85\n7,658,365\n55\n6,615,193\n\n\n7\n69\n8,354,956\n48\n6,911,757\n\n\n8\n61\n8,660,914\n41\n6,926,568\n\n\n9\n56\n8,450,191\n38\n6,592,392\n\n\n10\n50\n8,256,970\n34\n6,489,910\n\n\n11\n45\n8,436,602\n31\n6,399,787\n\n\n\n\n\n\n\n\n\n\n\n\n4.5.3 Data Visualization\nWe then visualize the age trajectories separately for men and women. The line chart displays median consultation rates at each age (0–11 years), allowing us to identify developmental windows where consultations increase sharply or begin to decline.\n\n\nCode\nAge_Sex_fig &lt;- Summary_Age_Sex %&gt;%\n  ggplot(aes(x= Age, y= MedianCases, color = Sex)) +\n    geom_line(size= 1.5) +\n    geom_point(shape=21, color = \"black\", fill = \"black\", size=4) +\n    ggtitle(\"\") +\n    scale_fill_manual(values = c(\"Men\" = \"#00BFC4\", \"Women\" = \"#F8766D\")) +\n    scale_color_manual(values = c(\"Men\" = \"#00BFC4\", \"Women\" = \"#F8766D\")) +\n  \n  scale_x_continuous(breaks = seq(0, 11, by = 2)) +\n  labs(y = \"Median number of consultations \\n per 10.000 (reference population)\",\n       x = \"Age\") +\n  Plot_theme +\n  theme (legend.position = c(0.9, 0.85),\n         legend.direction = \"vertical\") \n\nggsave(Age_Sex_fig ,\n       filename = \"Plots/Age_Sex_fig .png\",\n       width    = 12, \n       height   = 12, \n       units    = \"cm\")\n\n\nWarning: No shared levels found between `names(values)` of the manual scale and the\ndata's fill values.\n\n\nCode\nAge_Sex_fig\n\n\nWarning: No shared levels found between `names(values)` of the manual scale and the\ndata's fill values.\n\n\n\n\n\n\n\n\nFigure 4.4: Distribution of neurodevelopmental diagnostics per biological sex and age\n\n\n\n\n\nFigure 4.4 shows that males are more likely to be diagnosed, although both sexes peak at 6 years. Given the change in the trend, we find it suitable to model these behaviors using splines.\n\n\n4.5.4 Statistical Modeling\nThe age profiles in Figure Figure 4.4 show a clear non-linear pattern for both sexes, with a rapid increase in consultations during early childhood, a peak around school entry, and a gradual decline thereafter. To describe these trajectories more formally, we model the mean number of consultations per 10,000 inhabitants as a smooth function of age, allowing the shape of the curve to differ between men and women.\nWe work at the level of City × Sex × Age, which preserves spatial and demographic variability while keeping the outcome interpretable as an age-specific rate. We use a Student-t likelihood to remain robust to occasional extreme values and include a department-level random intercept to account for clustering of cities within departments.\n\n4.5.4.1 Data Preparation for the Spline Model\nWe next examine how consultation rates vary jointly with age and biological sex. To do this, we first summarise the neurodevelopmental diagnostics at the level of age–sex combinations. For each age in years (0–11) and each sex (men, women), we compute the mean number of consultations per 10,000 individuals in the corresponding reference population:\nMeanCases = mean of Diagnostics_per_tenthousand\nbased on all city-level observations contributing to that age–sex cell.\nThis aggregation gives us a smooth age profile for each sex and reduces the influence of highly variable single-city measurements.\n\n\nCode\nSummary_Age_Sex &lt;- Neuro_Data_MainDiag %&gt;%\n  group_by(City, Department, Age, Sex) %&gt;%\n  summarise(\n    MeanCases       = mean(Diagnostics_per_tenthousand, na.rm = TRUE),\n    Total_Population = sum(Population, na.rm = TRUE)\n  ) %&gt;%\n  ungroup()\n\nSummary_Age_Sex\n\n\n# A tibble: 19,164 × 6\n   City      Department   Age Sex   MeanCases Total_Population\n   &lt;chr&gt;     &lt;chr&gt;      &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt;            &lt;int&gt;\n 1 Abejorral Antioquia      1 Women      76.5              262\n 2 Abejorral Antioquia      2 Men        77.7              774\n 3 Abejorral Antioquia      2 Women      77.3              388\n 4 Abejorral Antioquia      3 Men        98.3              918\n 5 Abejorral Antioquia      3 Women      75.5              265\n 6 Abejorral Antioquia      4 Men       124.              1219\n 7 Abejorral Antioquia      4 Women      75                534\n 8 Abejorral Antioquia      5 Men        82.5              848\n 9 Abejorral Antioquia      5 Women      75                266\n10 Abejorral Antioquia      6 Men        85.5             1166\n# ℹ 19,154 more rows\n\n\n\n\n4.5.4.2 Fit the Model\nWe model the mean consultation rate as a function of sex and a smooth function of age that is allowed to differ between men and women. The model is defined as:\n\\[\n\\text{MeanCases}_{i s a}\n= \\beta_0\n+ \\beta_{\\text{Sex},s}\n+ f_s(\\text{Age}_{a})\n+ \\varepsilon_{i s a},\n\\]\nwhere:\n\n\\(i\\) indexes cities,\n\\(s\\) indexes biological sex (\\(s \\in \\{\\text{Men}, \\text{Women}\\}\\)),\n\\(a\\) indexes age groups.\n\nHere:\n\n\\(\\beta_0\\) is the intercept (expected consultation rate for men at Age = 0),\n\\(\\beta_{\\text{Sex},s}\\) adjusts the baseline for women relative to men,\n\\(f_s(\\text{Age})\\) is a sex-specific smooth spline function that captures the nonlinear age profile,\n\\(\\varepsilon_{i s a} \\sim t_\\nu(0, \\sigma)\\) is a Student-t residual term that provides robustness to extreme values and heterogeneity in the outcome.\n\nThe Student-t likelihood is:\n\\[\n\\text{MeanCases}_{i s a} \\sim t_\\nu(\\mu_{i s a},\\, \\sigma),\n\\]\nwith mean structure:\n\\[\n\\mu_{i s a}\n= \\beta_0\n+ \\beta_{\\text{Sex},s}\n+ f_s(\\text{Age}_{a}).\n\\]\nIn brms syntax, the model is:\n\n\nCode\nAge_Sex_mdl &lt;- bf(\n  MeanCases ~ Sex + s(Age, by = Sex, k = 2))\n\n\nAge_Sex_Fit1  &lt;- \n  brm(\n    family  = student,\n    data    = Summary_Age_Sex,\n    formula = Age_Sex_mdl,\n    chains  = 4,\n    cores   = 4,\n    warmup  = 2500, \n    iter    = 5000, \n    seed    = 8807,\n    control = list(adapt_delta = 0.99, max_treedepth = 15),\n    file    = \"Models/Age_Sex_Fit1.rds\",\n    file_refit = \"never\")\n\n\nHere, sex enters as a fixed effect and captures the average difference between men and women at the reference age.\ns(Age, by = Sex) fits separate penalised spline curves of age for men and women, so the shape of the age effect can differ by sex.\nWe use a Student-t likelihood (family = student) to accommodate heavy-tailed residuals and occasional extreme age–sex observations.\n\n\n4.5.4.3 Model Results\nWe can visualize the results using the summary function.\n\n\nCode\nsummary(Age_Sex_Fit1)\n\n\nWarning: There were 4 divergent transitions after warmup. Increasing\nadapt_delta above 0.99 may help. See\nhttp://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup\n\n\n Family: student \n  Links: mu = identity \nFormula: MeanCases ~ Sex + s(Age, by = Sex, k = 2) \n   Data: Summary_Age_Sex (Number of observations: 19164) \n  Draws: 4 chains, each with iter = 5000; warmup = 2500; thin = 1;\n         total post-warmup draws = 10000\n\nSmoothing Spline Hyperparameters:\n                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nsds(sAgeSexMen_1)     156.18     87.73    66.71   387.30 1.00     5239     5767\nsds(sAgeSexWomen_1)   110.98     63.11    42.88   281.76 1.00     5211     5893\n\nRegression Coefficients:\n                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nIntercept          93.84      0.71    92.43    95.22 1.00     7738     7344\nSexWomen          -21.99      0.92   -23.82   -20.20 1.00    10074     7225\nsAge:SexMen_1       3.99      0.63     2.76     5.21 1.00     9907     7444\nsAge:SexWomen_1     1.86      0.68     0.52     3.18 1.00     9001     6865\n\nFurther Distributional Parameters:\n      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nsigma    48.65      0.55    47.56    49.73 1.00     6368     6908\nnu        1.68      0.03     1.62     1.73 1.00     6126     6599\n\nDraws were sampled using sampling(NUTS). For each parameter, Bulk_ESS\nand Tail_ESS are effective sample size measures, and Rhat is the potential\nscale reduction factor on split chains (at convergence, Rhat = 1).\n\n\nThe intercept (~93.8) represents the mean number of consultations per 10,000 for men at the reference age (the centre of the age distribution). The coefficient for SexWomen (about −22) indicates that, at the same reference age, women show substantially lower consultation rates than men. The spline hyperparameters (sds(sAgeSexMen_1) and sds(sAgeSexwomen_1)) quantify the amount of non-linear variability across age for each sex; both are clearly above zero, which supports modelling a curved age effect instead of a simple straight line.\nThe residual scale (sigma ≈ 49) and degrees of freedom parameter (nu ≈ 1.7) confirm heavy-tailed residuals, consistent with our choice of a Student-t distribution.\n\n4.5.4.3.1 Estimate the Derivatives\nTo describe the fitted trajectories in a more interpretable way, we use estimate_relation() from the modelbased package. We generate model-based predictions across age for each sex:\n\nWe request a grid of 5 equally spaced ages between 0 and 11 years.\nFor each age–sex combination, we obtain the posterior mean of MeanCases and its 95% credible interval.\n\n\n\nCode\nlibrary(modelbased)\n\n# Create relation: predictions over Age, moderated by Sex\nrel_age_sex &lt;- estimate_relation(\n  model          = Age_Sex_Fit1,\n  effect         = \"Age\",\n  moderator      = \"Sex\",\n  length         = 5,        # number of points along Age\n  include_random = FALSE       # population-level trajectories\n)\n\nrel_age_sex\n\n\nModel-based Predictions\n\nSex   |   Age | Predicted |   SE |           95% CI\n---------------------------------------------------\nMen   |  0.00 |     59.72 | 1.90 | [ 56.01,  63.40]\nWomen |  0.00 |     52.74 | 2.05 | [ 48.73,  56.79]\nMen   |  2.75 |     92.86 | 0.92 | [ 91.07,  94.69]\nWomen |  2.75 |     71.74 | 0.98 | [ 69.83,  73.64]\nMen   |  5.50 |    109.05 | 1.07 | [106.96, 111.13]\nWomen |  5.50 |     80.81 | 1.04 | [ 78.77,  82.88]\nMen   |  8.25 |     99.78 | 0.91 | [ 97.98, 101.55]\nWomen |  8.25 |     74.96 | 0.90 | [ 73.19,  76.72]\nMen   | 11.00 |     73.56 | 1.61 | [ 70.38,  76.74]\nWomen | 11.00 |     59.19 | 1.67 | [ 56.00,  62.49]\n\nVariable predicted: MeanCases\nPredictors modulated: Sex, Age\nPredictions are on the response-scale.\n\n\nThe resulting table (model-based expectation) shows, for example:\n\nWomen: predicted consultation rates increase from about 53 consultations per 10,000 at birth (95% CrI ≈ 49–57) to about 81 at age 5.5 (CrI ≈ 79–83), then gradually decline to about 59 at age 11 (CrI ≈ 56–62).\nMen: the corresponding trajectory is higher at every age: about 60 per 10,000 at birth (CrI ≈ 56–63), peaking around 109 at age 5.5 (CrI ≈ 107–111) and declining to about 74 at age 11 (CrI ≈ 70–77).\n\nWe save the table in HTML and LaTeX format:\n\n\nCode\nlibrary(dplyr)\nlibrary(gt)\n\n# Make a clean table dataframe\nrel_age_sex_tbl &lt;- rel_age_sex %&gt;%\n  # keep the key columns and rename if needed\n  transmute(\n    Age       = Age,\n    Sex       = Sex,\n    Predicted = Predicted,\n    CI_low    = CI_low,\n    CI_high   = CI_high\n  )\n\n# Build APA-like gt table\nage_sex_relation_gt &lt;- rel_age_sex_tbl %&gt;%\n  gt() %&gt;%\n  cols_label(\n    Age       = \"Age\",\n    Sex       = \"Sex\",\n    Predicted = \"Predicted mean\",\n    CI_low    = \"95% CI (low)\",\n    CI_high   = \"95% CI (high)\"\n  ) %&gt;%\n  fmt_number(\n    columns  = c(Predicted, CI_low, CI_high),\n    decimals = 1\n  ) %&gt;%\n  tab_header(\n    title = md(\"**Table X. Model-based consultation rates per 10,000 inhabitants by age and sex**\"),\n    subtitle = \"Predicted values and 95% credible intervals from the spline model MeanCases ~ Sex + s(Age, by = Sex, k = 6).\"\n  ) %&gt;%\n  theme_apa_gt()\n\n# Save to HTML and LaTeX\ngtsave(age_sex_relation_gt, filename = \"Tables/AgeSex_relation.html\")\ngtsave(age_sex_relation_gt, filename = \"Tables/AgeSex_relation.tex\")\n\nage_sex_relation_gt\n\n\n\n\nTable 4.8: Model-based predicted consultation rates by age and sex\n\n\n\n\n\n\n\n\n\nTable X. Model-based consultation rates per 10,000 inhabitants by age and sex\n\n\nPredicted values and 95% credible intervals from the spline model MeanCases ~ Sex + s(Age, by = Sex, k = 6).\n\n\nAge\nSex\nPredicted mean\n95% CI (low)\n95% CI (high)\n\n\n\n\n0.00\nWomen\n52.7\n48.7\n56.8\n\n\n2.75\nWomen\n71.7\n69.8\n73.6\n\n\n5.50\nWomen\n80.8\n78.8\n82.9\n\n\n8.25\nWomen\n75.0\n73.2\n76.7\n\n\n11.00\nWomen\n59.2\n56.0\n62.5\n\n\n0.00\nMen\n59.7\n56.0\n63.4\n\n\n2.75\nMen\n92.9\n91.1\n94.7\n\n\n5.50\nMen\n109.0\n107.0\n111.1\n\n\n8.25\nMen\n99.8\n98.0\n101.5\n\n\n11.00\nMen\n73.6\n70.4\n76.7\n\n\n\n\n\n\n\n\n\n\nAnd finally in Word format:\n\n\n\nTable 4.9\n\n\n\nCode\nlibrary(flextable)\nlibrary(officer)\nlibrary(dplyr)\n\n# Start from the same cleaned data\nrel_age_sex_ft_dat &lt;- rel_age_sex %&gt;%\n  transmute(\n    Age       = Age,\n    Sex       = Sex,\n    Predicted = round(Predicted, 1),\n    CI        = sprintf(\"%.1f, %.1f\", CI_low, CI_high)\n  )\n\nage_sex_relation_ft &lt;- rel_age_sex_ft_dat %&gt;%\n  flextable() %&gt;%\n  set_header_labels(\n    Age       = \"Age\",\n    Sex       = \"Sex\",\n    Predicted = \"Predicted mean\",\n    CI        = \"95% CI\"\n  ) %&gt;%\n\n  theme_apa_flextable() %&gt;%\n  align(part = \"header\", align = \"center\") %&gt;%\n  bold(part = \"header\", bold = TRUE) %&gt;%\n  align(j = c(\"Predicted\", \"CI\"), align = \"right\", part = \"body\") %&gt;%\n  add_footer_lines(\n    values = \"Note. Predicted mean number of consultations per 10,000 inhabitants and 95% credible intervals from the spline model.\"\n  ) %&gt;%\n  align(part = \"footer\", align = \"left\")\n\n# Export to Word\nsave_as_docx(\n  \"Table X. Model-based consultation rates per 10,000 inhabitants by age and sex\" = age_sex_relation_ft,\n  path = \"Tables/AgeSex_relation.docx\"\n)\n\n\n\n\n\n\n\n\n4.5.5 Derivatives Plot\nWe then visualise these predictions as in the attached figure: solid lines give the posterior means by age for each sex, and ribbons represent 95% credible intervals.\n\n\nCode\n# Plot\nAge_Sex_relation_fig &lt;- rel_age_sex %&gt;%\n  ggplot(aes(x = Age, y = Predicted, colour = Sex, fill = Sex)) +\n  geom_ribbon(aes(ymin = CI_low, ymax = CI_high),\n              alpha = 0.2, colour = NA) +\n  geom_line(size = 1.2) +\n  scale_color_manual(values = c(\"Men\" = \"#00BFC4\", \"Women\" = \"#F8766D\")) +\n  scale_fill_manual(values  = c(\"Men\" = \"#00BFC4\", \"Women\" = \"#F8766D\")) +\n  labs(\n    x = \"Age\",\n    y = \"Number of consultations\\nper 10,000 (reference population)\",\n    caption = \"Model: MeanCases ~ Sex + s(Age, by = Sex, k = 6)\"\n  ) +\n  Plot_theme +\n  theme(\n    legend.position  = c(0.9, 0.85),\n    legend.direction = \"vertical\"\n  )\n\nggsave(\n  Age_Sex_relation_fig,\n  filename = \"Plots/Age_Sex_relation_fig.png\",\n  width    = 12,\n  height   = 12,\n  units    = \"cm\"\n)\n\nAge_Sex_relation_fig\n\n\n\n\n\n\n\n\nFigure 4.5: Model-based age trajectories of mean consultation rates per 10,000 inhabitants by sex.\n\n\n\n\n\nThe plot shows parallel, slightly curved trajectories, with men consistently above women and both sexes peaking in early school age.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Frequency of the top 3 Diagnostics</span>"
    ]
  },
  {
    "objectID": "4_Interactive_App.html",
    "href": "4_Interactive_App.html",
    "title": "Interactive App",
    "section": "",
    "text": "This chapter features a fully interactive version of the NeuroColombia Explorer, running directly in your browser using Shinylive.\n\n\n\n\n\n\nNote\n\n\n\nThis application runs entirely in your web browser via WebAssembly. No server is required!\nOpen App in New Window (Fullscreen)\n\n\n#| '!! shinylive warning !!': |\n#|   shinylive does not work in self-contained HTML documents.\n#|   Please set `embed-resources: false` in your metadata.\n#| standalone: true\n#| viewerHeight: 800\n\nlibrary(shiny)\nlibrary(bslib)\nThis chapter features a fully interactive version of the NeuroColombia Explorer, running directly in your browser using Shinylive.\n\n\n\n\n\n\nNote\n\n\n\nThis application runs entirely in your web browser via WebAssembly. No server is required!\n\n\n#| '!! shinylive warning !!': |\n#|   shinylive does not work in self-contained HTML documents.\n#|   Please set `embed-resources: false` in your metadata.\n#| standalone: true\n#| viewerHeight: 800\n\nlibrary(shiny)\nlibrary(bslib)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(plotly)\nlibrary(leaflet)\nlibrary(sf)\nlibrary(scales)\nlibrary(DT)\nlibrary(glue)\nlibrary(bsicons)\nlibrary(munsell)\nlibrary(colorspace)\nlibrary(labeling)\n\n# ---- Data Loading ----\n# Load optimized data from GitHub Raw URL\ndata_url &lt;- \"https://raw.githubusercontent.com/daniel-manrique/DS_NeuroColombia/main/app/data/Neuro_Data_App.csv\"\nmap_url &lt;- \"https://raw.githubusercontent.com/daniel-manrique/DS_NeuroColombia/main/app/data/Colombia_Map.rds\"\n\n# Function to read CSV safely\nread_data &lt;- function(url) {\n  tryCatch(\n    {\n      read.csv(url, stringsAsFactors = FALSE)\n    },\n    error = function(e) {\n      NULL\n    }\n  )\n}\n\n# Function to download and read RDS map safely\nread_map &lt;- function(url) {\n  tryCatch({\n    download.file(url, \"map.rds\", mode = \"wb\")\n    readRDS(\"map.rds\")\n  }, error = function(e) NULL)\n}\n\nraw_data &lt;- read_data(data_url)\ncolombia_map &lt;- read_map(map_url)\n\n# Fallback or Processing\nif (is.null(raw_data)) {\n  Neuro_Data &lt;- data.frame(\n    Year = integer(), Department = character(), Capital = character(),\n    Diagnostic = character(), Age = numeric(), Sex = character(),\n    Cases = numeric(), Population = numeric()\n  )\n} else {\n  Neuro_Data &lt;- raw_data |&gt;\n    mutate(\n      Year = as.integer(Year),\n      Age = suppressWarnings(as.numeric(Age)),\n      Cases = as.numeric(Cases),\n      Population = as.numeric(Population),\n      Capital = if_else(Capital == \"Yes\", \"Yes\", \"No\")\n    )\n}\n\ndiagnostic_choices &lt;- sort(unique(Neuro_Data$Diagnostic))\ndiag_default &lt;- intersect(c(\"F900\", \"F809\", \"F808\"), diagnostic_choices)\ndept_choices &lt;- sort(unique(Neuro_Data$Department))\n\nyear_range &lt;- range(Neuro_Data$Year, na.rm = TRUE)\nage_range &lt;- range(Neuro_Data$Age, na.rm = TRUE)\n\n# Custom Theme\nmy_theme &lt;- bs_theme(\n  bootswatch = \"zephyr\",\n  primary = \"#0a4f63\",\n  secondary = \"#4DB6D0\",\n  success = \"#69b3a2\"\n)\n\n# Plot Theme\nplot_theme &lt;- theme_minimal() +\n  theme(\n    plot.title = element_text(size = 14, face = \"bold\"),\n    axis.title = element_text(size = 12),\n    axis.text = element_text(size = 10),\n    legend.position = \"bottom\",\n    panel.grid.minor = element_blank()\n  )\n\n# ---- UI ----------------------------------------------------------------------\n\nui &lt;- page_sidebar(\n  theme = my_theme,\n  title = \"NeuroColombia Explorer\",\n  \n  sidebar = sidebar(\n    title = \"Filters\",\n    width = 300,\n    selectInput(\"dept_filter\", \"Department\", choices = c(\"All Departments\" = \"All\", dept_choices), selected = \"All\"),\n    sliderInput(\"year_range\", \"Year range\", min = year_range[1], max = year_range[2], value = year_range, sep = \"\"),\n    sliderInput(\"age_range\", \"Age range\", min = age_range[1], max = age_range[2], value = age_range),\n    checkboxGroupInput(\"sex\", \"Sex\", choices = sort(unique(Neuro_Data$Sex)), selected = sort(unique(Neuro_Data$Sex))),\n    checkboxGroupInput(\"capital\", \"Capital city status\", choices = c(\"Yes\", \"No\"), selected = c(\"Yes\", \"No\"), inline = TRUE),\n    selectizeInput(\"diagnostics\", \"ICD-10 diagnostics\", choices = diagnostic_choices, selected = diag_default, multiple = TRUE, options = list(placeholder = \"All diagnostics\", maxOptions = 500)),\n    actionLink(\"clear_diags\", \"Clear selection\")\n  ),\n\n  navset_card_underline(\n    title = \"Analysis Modules\",\n    \n    # --- Tab 1: Overview ---\n    nav_panel(\n      \"Overview\",\n      layout_columns(\n        fill = FALSE,\n        value_box(\n          title = \"Total Consultations\",\n          value = textOutput(\"vb_total_cases\"),\n          showcase = bs_icon(\"people-fill\"),\n          theme_color = \"primary\"\n        ),\n        value_box(\n          title = \"Departments\",\n          value = textOutput(\"vb_departments\"),\n          showcase = bs_icon(\"geo-alt-fill\"),\n          theme_color = \"secondary\"\n        ),\n        value_box(\n          title = \"Top Diagnostic\",\n          value = textOutput(\"vb_top_diag\"),\n          showcase = bs_icon(\"activity\"),\n          theme_color = \"success\"\n        )\n      ),\n      layout_columns(\n        card(\n          full_screen = TRUE,\n          card_header(\"Consultations over Time\"),\n          plotlyOutput(\"cases_over_time\")\n        ),\n        card(\n          full_screen = TRUE,\n          card_header(\"Age & Sex Distribution\"),\n          plotlyOutput(\"age_sex_plot\")\n        )\n      )\n    ),\n\n    # --- Tab 2: Geography ---\n    nav_panel(\n      \"Geography\",\n      layout_columns(\n        col_widths = c(8, 4),\n        card(\n          full_screen = TRUE,\n          card_header(\n            class = \"d-flex justify-content-between align-items-center\",\n            \"Geographic Distribution\",\n            input_switch(\"map_rate_toggle\", \"Show Rate per 100k\", value = FALSE)\n          ),\n          leafletOutput(\"department_map\", height = \"600px\")\n        ),\n        card(\n          full_screen = TRUE,\n          card_header(\"Top Departments\"),\n          plotlyOutput(\"department_bar\", height = \"600px\")\n        )\n      )\n    ),\n\n    # --- Tab 3: Distributions ---\n    nav_panel(\n      \"Distributions\",\n      layout_columns(\n        card(\n          full_screen = TRUE,\n          card_header(\"Departmental Variability (Box Plot)\"),\n          plotlyOutput(\"dept_boxplot\")\n        ),\n        card(\n          full_screen = TRUE,\n          card_header(\"Age Distribution by Sex (Box Plot)\"),\n          plotlyOutput(\"age_sex_boxplot\")\n        )\n      )\n    ),\n\n    # --- Tab 4: Diagnostics ---\n    nav_panel(\n      \"Diagnostics\",\n      layout_columns(\n        card(\n          full_screen = TRUE,\n          card_header(\"Most Frequent Diagnostics\"),\n          plotlyOutput(\"diagnostic_bar\")\n        ),\n        card(\n          full_screen = TRUE,\n          card_header(\"Detailed Statistics\"),\n          DTOutput(\"diagnostic_table\")\n        )\n      )\n    )\n  )\n)\n\n# ---- Server ------------------------------------------------------------------\n\nserver &lt;- function(input, output, session) {\n\n  observeEvent(input$clear_diags, {\n    updateSelectizeInput(session, \"diagnostics\", selected = character(0))\n  })\n\n  filtered_data &lt;- reactive({\n    req(nrow(Neuro_Data) &gt; 0)\n    sexes &lt;- if (length(input$sex) &gt; 0) input$sex else unique(Neuro_Data$Sex)\n    capitals &lt;- if (length(input$capital) &gt; 0) input$capital else c(\"Yes\", \"No\")\n\n    res &lt;- Neuro_Data |&gt;\n      filter(\n        Year &gt;= input$year_range[1],\n        Year &lt;= input$year_range[2],\n        Age &gt;= input$age_range[1],\n        Age &lt;= input$age_range[2],\n        Sex %in% sexes,\n        Capital %in% capitals\n      )\n      \n    if (input$dept_filter != \"All\") {\n      res &lt;- res |&gt; filter(Department == input$dept_filter)\n    }\n      \n    if (length(input$diagnostics) &gt; 0) {\n      res &lt;- res |&gt; filter(Diagnostic %in% input$diagnostics)\n    }\n    \n    res\n  })\n\n  # ---- Value Boxes ----\n  overview_metrics &lt;- reactive({\n    data &lt;- filtered_data()\n    list(\n      total = sum(data$Cases, na.rm = TRUE),\n      depts = n_distinct(data$Department),\n      top = data |&gt; count(Diagnostic, wt = Cases, sort = TRUE) |&gt; slice(1)\n    )\n  })\n\n  output$vb_total_cases &lt;- renderText({ comma(overview_metrics()$total) })\n  output$vb_departments &lt;- renderText({ overview_metrics()$depts })\n  output$vb_top_diag &lt;- renderText({\n    m &lt;- overview_metrics()$top\n    if(nrow(m) &gt; 0) paste0(m$Diagnostic, \" (\", comma(m$n), \")\") else \"N/A\"\n  })\n\n  # ---- Plots: Overview ----\n  output$cases_over_time &lt;- renderPlotly({\n    d &lt;- filtered_data() |&gt; group_by(Year) |&gt; summarise(Total = sum(Cases, na.rm = TRUE))\n    validate(need(nrow(d) &gt; 0, \"No data\"))\n    \n    p &lt;- ggplot(d, aes(x = Year, y = Total)) +\n      geom_line(color = \"#4DB6D0\", linewidth = 1.2) +\n      geom_point(color = \"#0a4f63\", size = 3) +\n      scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n      labs(x = NULL, y = \"Consultations\") +\n      plot_theme\n    \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  output$age_sex_plot &lt;- renderPlotly({\n    d &lt;- filtered_data() |&gt; group_by(Age, Sex) |&gt; summarise(Total = sum(Cases, na.rm = TRUE), .groups = \"drop\")\n    validate(need(nrow(d) &gt; 0, \"No data\"))\n    \n    p &lt;- ggplot(d, aes(x = Age, y = Total, color = Sex)) +\n      geom_line(linewidth = 1) +\n      scale_color_manual(values = c(\"Men\" = \"#00BFC4\", \"Women\" = \"#F8766D\")) +\n      labs(x = \"Age\", y = \"Consultations\") +\n      plot_theme\n    \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  # ---- Geography ----\n  dept_summary &lt;- reactive({\n    filtered_data() |&gt;\n      group_by(Department) |&gt;\n      summarise(\n        Total = sum(Cases, na.rm = TRUE),\n        Rate = ifelse(sum(Population) &gt; 0, (sum(Cases)/sum(Population))*1e5, 0),\n        .groups = \"drop\"\n      )\n  })\n\n  output$department_map &lt;- renderLeaflet({\n    req(colombia_map)\n    d &lt;- dept_summary()\n    map_data &lt;- colombia_map |&gt; left_join(d, by = \"Department\")\n    \n    # Pre-calculate strings to avoid parser issues\n    suffix &lt;- if(input$map_rate_toggle) \" per 100k\" else \" cases\"\n    legend_title &lt;- if(input$map_rate_toggle) \"Rate / 100k\" else \"Total Cases\"\n    \n    metric &lt;- if(input$map_rate_toggle) \"Rate\" else \"Total\"\n    vals &lt;- map_data[[metric]]\n    \n    # Handle case where all values are NA or 0 to prevent palette error\n    if(all(is.na(vals)) || all(vals == 0)) {\n       leaflet(map_data) |&gt;\n        addProviderTiles(providers$CartoDB.Positron) |&gt;\n        addPolygons(weight = 1, color = \"#666\", fillOpacity = 0.1)\n    } else {\n      pal &lt;- colorNumeric(\"YlOrRd\", domain = vals, na.color = \"#eee\")\n      \n      leaflet(map_data) |&gt;\n        addProviderTiles(providers$CartoDB.Positron) |&gt;\n        addPolygons(\n          fillColor = ~pal(vals), weight = 1, color = \"#666\", fillOpacity = 0.8,\n          label = ~paste0(Department, \": \", comma(round(vals, 1)), suffix),\n          highlight = highlightOptions(weight = 3, color = \"#333\", bringToFront = TRUE)\n        ) |&gt;\n        addLegend(pal = pal, values = vals, title = legend_title)\n    }\n  })\n\n  output$department_bar &lt;- renderPlotly({\n    d &lt;- dept_summary() |&gt; arrange(desc(Total)) |&gt; slice_head(n = 15)\n    validate(need(nrow(d) &gt; 0, \"No data\"))\n    \n    p &lt;- ggplot(d, aes(x = Total, y = reorder(Department, Total))) +\n      geom_col(fill = \"#69b3a2\") +\n      geom_text(aes(label = comma(Total)), hjust = -0.1, size = 3) +\n      labs(x = \"Total Cases\", y = NULL) +\n      plot_theme +\n      scale_x_continuous(expand = expansion(mult = c(0, 0.2)))\n    \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  # ---- Distributions (Box Plots) ----\n  output$dept_boxplot &lt;- renderPlotly({\n    d &lt;- filtered_data() |&gt;\n      group_by(Department, Year) |&gt;\n      summarise(Total = sum(Cases, na.rm = TRUE), .groups = \"drop\")\n    \n    validate(need(nrow(d) &gt; 0, \"No data\"))\n    \n    p &lt;- ggplot(d, aes(x = reorder(Department, Total, median), y = Total)) +\n      geom_boxplot(fill = \"#4DB6D0\", alpha = 0.7, outlier.size = 1) +\n      coord_flip() +\n      labs(x = NULL, y = \"Annual Cases\") +\n      plot_theme\n    \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  output$age_sex_boxplot &lt;- renderPlotly({\n    d &lt;- filtered_data() |&gt;\n      group_by(Age, Sex, Year) |&gt;\n      summarise(Cases = sum(Cases, na.rm = TRUE), .groups = \"drop\")\n      \n    validate(need(nrow(d) &gt; 0, \"No data\"))\n\n    p &lt;- ggplot(d, aes(x = factor(Age), y = Cases, fill = Sex)) +\n      geom_boxplot(outlier.size = 0.5) +\n      scale_fill_manual(values = c(\"Men\" = \"#00BFC4\", \"Women\" = \"#F8766D\")) +\n      labs(x = \"Age\", y = \"Annual Cases\") +\n      plot_theme +\n      theme(legend.position = \"none\")\n      \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  # ---- Diagnostics ----\n  output$diagnostic_bar &lt;- renderPlotly({\n    d &lt;- filtered_data() |&gt; group_by(Diagnostic) |&gt; summarise(Total = sum(Cases, na.rm = TRUE)) |&gt; arrange(desc(Total)) |&gt; slice_head(n = 15)\n    validate(need(nrow(d) &gt; 0, \"No data\"))\n    \n    p &lt;- ggplot(d, aes(x = Total, y = reorder(Diagnostic, Total), fill = Total)) +\n      geom_col(show.legend = FALSE) +\n      scale_fill_distiller(palette = \"Blues\", direction = 1) +\n      labs(x = \"Total Cases\", y = NULL) +\n      plot_theme\n    \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  output$diagnostic_table &lt;- renderDT({\n    filtered_data() |&gt;\n      group_by(Diagnostic) |&gt;\n      summarise(Total = sum(Cases, na.rm = TRUE)) |&gt;\n      arrange(desc(Total)) |&gt;\n      mutate(Total = comma(Total)) |&gt;\n      datatable(options = list(pageLength = 10))\n  })\n}\n\nshinyApp(ui, server)",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Interactive App</span>"
    ]
  }
]