[
  {
    "objectID": "4_Interactive_App.html",
    "href": "4_Interactive_App.html",
    "title": "5  Interactive App",
    "section": "",
    "text": "This chapter features a fully interactive version of the NeuroColombia Explorer, running directly in your browser using Shinylive.\n\n\n\n\n\n\nNote\n\n\n\nThis application runs entirely in your web browser via WebAssembly. No server is required!\n\n\n#| '!! shinylive warning !!': |\n#|   shinylive does not work in self-contained HTML documents.\n#|   Please set `embed-resources: false` in your metadata.\n#| standalone: true\n#| viewerHeight: 800\n\nlibrary(shiny)\nlibrary(bslib)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(plotly)\nlibrary(leaflet)\nlibrary(sf)\nlibrary(rnaturalearth)\nlibrary(scales)\nlibrary(DT)\nlibrary(glue)\nlibrary(bsicons)\n\n# ---- Data Loading ----\n# Load optimized data from GitHub Raw URL\ndata_url &lt;- \"https://raw.githubusercontent.com/daniel-manrique/DS_NeuroColombia/main/app/data/Neuro_Data_App.csv\"\n\n# Function to read CSV safely\nread_data &lt;- function(url) {\n  tryCatch(\n    {\n      read.csv(url, stringsAsFactors = FALSE)\n    },\n    error = function(e) {\n      NULL\n    }\n  )\n}\n\nraw_data &lt;- read_data(data_url)\n\n# Fallback or Processing\nif (is.null(raw_data)) {\n  Neuro_Data &lt;- data.frame(\n    Year = integer(), Department = character(), Capital = character(),\n    Diagnostic = character(), Age = numeric(), Sex = character(),\n    Cases = numeric(), Population = numeric()\n  )\n} else {\n  Neuro_Data &lt;- raw_data |&gt;\n    mutate(\n      Year = as.integer(Year),\n      Age = suppressWarnings(as.numeric(Age)),\n      Cases = as.numeric(Cases),\n      Population = as.numeric(Population),\n      Capital = if_else(Capital == \"Yes\", \"Yes\", \"No\")\n    )\n}\n\ndiagnostic_choices &lt;- sort(unique(Neuro_Data$Diagnostic))\ndiag_default &lt;- intersect(c(\"F900\", \"F809\", \"F808\"), diagnostic_choices)\n\nyear_range &lt;- range(Neuro_Data$Year, na.rm = TRUE)\nage_range &lt;- range(Neuro_Data$Age, na.rm = TRUE)\n\n# Build Colombia map (Simplified for WebR if needed, but rnaturalearth should work)\n# Note: rnaturalearth might need internet to fetch map data if not cached. \n# Ideally we would bundle the map sf object, but for now we try fetching.\ncolombia_map &lt;- tryCatch({\n  rnaturalearth::ne_states(country = \"Colombia\", returnclass = \"sf\") |&gt;\n    dplyr::select(name_en, geometry) |&gt;\n    mutate(\n      Department = name_en # Simplified mapping for now, assuming name_en matches or is close\n    ) |&gt;\n    # Manual fix for matching names in dataset if needed\n    mutate(\n      Department = case_when(\n        Department == \"Bogota\" ~ \"Bogota, D.C.\",\n        Department == \"Archipelago of Saint Andrews\" ~ \"Archipielago de San Andres, Providencia Y Santa Catalina\",\n        TRUE ~ Department\n      )\n    )\n}, error = function(e) NULL)\n\n\n# Custom Theme\nmy_theme &lt;- bs_theme(\n  bootswatch = \"zephyr\",\n  primary = \"#0a4f63\",\n  secondary = \"#4DB6D0\",\n  success = \"#69b3a2\"\n)\n\n# Plot Theme\nplot_theme &lt;- theme_minimal() +\n  theme(\n    plot.title = element_text(size = 14, face = \"bold\"),\n    axis.title = element_text(size = 12),\n    axis.text = element_text(size = 10),\n    legend.position = \"bottom\",\n    panel.grid.minor = element_blank()\n  )\n\n# ---- UI ----------------------------------------------------------------------\n\nui &lt;- page_sidebar(\n  theme = my_theme,\n  title = \"NeuroColombia Explorer\",\n  \n  sidebar = sidebar(\n    title = \"Filters\",\n    width = 300,\n    sliderInput(\"year_range\", \"Year range\", min = year_range[1], max = year_range[2], value = year_range, sep = \"\"),\n    sliderInput(\"age_range\", \"Age range\", min = age_range[1], max = age_range[2], value = age_range),\n    checkboxGroupInput(\"sex\", \"Sex\", choices = sort(unique(Neuro_Data$Sex)), selected = sort(unique(Neuro_Data$Sex))),\n    checkboxGroupInput(\"capital\", \"Capital city status\", choices = c(\"Yes\", \"No\"), selected = c(\"Yes\", \"No\"), inline = TRUE),\n    selectizeInput(\"diagnostics\", \"ICD-10 diagnostics\", choices = diagnostic_choices, selected = diag_default, multiple = TRUE, options = list(placeholder = \"All diagnostics\", maxOptions = 500)),\n    actionLink(\"clear_diags\", \"Clear selection\")\n  ),\n\n  navset_card_underline(\n    title = \"Analysis Modules\",\n    \n    # --- Tab 1: Overview ---\n    nav_panel(\n      \"Overview\",\n      layout_columns(\n        fill = FALSE,\n        value_box(\n          title = \"Total Consultations\",\n          value = textOutput(\"vb_total_cases\"),\n          showcase = bs_icon(\"people-fill\"),\n          theme_color = \"primary\"\n        ),\n        value_box(\n          title = \"Departments\",\n          value = textOutput(\"vb_departments\"),\n          showcase = bs_icon(\"geo-alt-fill\"),\n          theme_color = \"secondary\"\n        ),\n        value_box(\n          title = \"Top Diagnostic\",\n          value = textOutput(\"vb_top_diag\"),\n          showcase = bs_icon(\"activity\"),\n          theme_color = \"success\"\n        )\n      ),\n      layout_columns(\n        card(\n          full_screen = TRUE,\n          card_header(\"Consultations over Time\"),\n          plotlyOutput(\"cases_over_time\")\n        ),\n        card(\n          full_screen = TRUE,\n          card_header(\"Age & Sex Distribution\"),\n          plotlyOutput(\"age_sex_plot\")\n        )\n      )\n    ),\n\n    # --- Tab 2: Geography ---\n    nav_panel(\n      \"Geography\",\n      layout_columns(\n        col_widths = c(8, 4),\n        card(\n          full_screen = TRUE,\n          card_header(\n            class = \"d-flex justify-content-between align-items-center\",\n            \"Geographic Distribution\",\n            input_switch(\"map_rate_toggle\", \"Show Rate per 100k\", value = FALSE)\n          ),\n          leafletOutput(\"department_map\", height = \"600px\")\n        ),\n        card(\n          full_screen = TRUE,\n          card_header(\"Top Departments\"),\n          plotlyOutput(\"department_bar\", height = \"600px\")\n        )\n      )\n    ),\n\n    # --- Tab 3: Distributions ---\n    nav_panel(\n      \"Distributions\",\n      layout_columns(\n        card(\n          full_screen = TRUE,\n          card_header(\"Departmental Variability (Box Plot)\"),\n          plotlyOutput(\"dept_boxplot\")\n        ),\n        card(\n          full_screen = TRUE,\n          card_header(\"Age Distribution by Sex (Box Plot)\"),\n          plotlyOutput(\"age_sex_boxplot\")\n        )\n      )\n    ),\n\n    # --- Tab 4: Diagnostics ---\n    nav_panel(\n      \"Diagnostics\",\n      layout_columns(\n        card(\n          full_screen = TRUE,\n          card_header(\"Most Frequent Diagnostics\"),\n          plotlyOutput(\"diagnostic_bar\")\n        ),\n        card(\n          full_screen = TRUE,\n          card_header(\"Detailed Statistics\"),\n          DTOutput(\"diagnostic_table\")\n        )\n      )\n    )\n  )\n)\n\n# ---- Server ------------------------------------------------------------------\n\nserver &lt;- function(input, output, session) {\n\n  observeEvent(input$clear_diags, {\n    updateSelectizeInput(session, \"diagnostics\", selected = character(0))\n  })\n\n  filtered_data &lt;- reactive({\n    req(nrow(Neuro_Data) &gt; 0)\n    sexes &lt;- if (length(input$sex) &gt; 0) input$sex else unique(Neuro_Data$Sex)\n    capitals &lt;- if (length(input$capital) &gt; 0) input$capital else c(\"Yes\", \"No\")\n\n    Neuro_Data |&gt;\n      filter(\n        Year &gt;= input$year_range[1],\n        Year &lt;= input$year_range[2],\n        Age &gt;= input$age_range[1],\n        Age &lt;= input$age_range[2],\n        Sex %in% sexes,\n        Capital %in% capitals\n      ) |&gt;\n      { if (length(input$diagnostics) &gt; 0) filter(., Diagnostic %in% input$diagnostics) else . }\n  })\n\n  # ---- Value Boxes ----\n  overview_metrics &lt;- reactive({\n    data &lt;- filtered_data()\n    list(\n      total = sum(data$Cases, na.rm = TRUE),\n      depts = n_distinct(data$Department),\n      top = data |&gt; count(Diagnostic, wt = Cases, sort = TRUE) |&gt; slice(1)\n    )\n  })\n\n  output$vb_total_cases &lt;- renderText({ comma(overview_metrics()$total) })\n  output$vb_departments &lt;- renderText({ overview_metrics()$depts })\n  output$vb_top_diag &lt;- renderText({\n    m &lt;- overview_metrics()$top\n    if(nrow(m) &gt; 0) paste0(m$Diagnostic, \" (\", comma(m$n), \")\") else \"N/A\"\n  })\n\n  # ---- Plots: Overview ----\n  output$cases_over_time &lt;- renderPlotly({\n    d &lt;- filtered_data() |&gt; group_by(Year) |&gt; summarise(Total = sum(Cases, na.rm = TRUE))\n    validate(need(nrow(d) &gt; 0, \"No data\"))\n    \n    p &lt;- ggplot(d, aes(x = Year, y = Total)) +\n      geom_line(color = \"#4DB6D0\", linewidth = 1.2) +\n      geom_point(color = \"#0a4f63\", size = 3) +\n      scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n      labs(x = NULL, y = \"Consultations\") +\n      plot_theme\n    \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  output$age_sex_plot &lt;- renderPlotly({\n    d &lt;- filtered_data() |&gt; group_by(Age, Sex) |&gt; summarise(Total = sum(Cases, na.rm = TRUE), .groups = \"drop\")\n    validate(need(nrow(d) &gt; 0, \"No data\"))\n    \n    p &lt;- ggplot(d, aes(x = Age, y = Total, color = Sex)) +\n      geom_line(linewidth = 1) +\n      scale_color_manual(values = c(\"Men\" = \"#00BFC4\", \"Women\" = \"#F8766D\")) +\n      labs(x = \"Age\", y = \"Consultations\") +\n      plot_theme\n    \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  # ---- Geography ----\n  dept_summary &lt;- reactive({\n    filtered_data() |&gt;\n      group_by(Department) |&gt;\n      summarise(\n        Total = sum(Cases, na.rm = TRUE),\n        Rate = ifelse(sum(Population) &gt; 0, (sum(Cases)/sum(Population))*1e5, 0),\n        .groups = \"drop\"\n      )\n  })\n\n  output$department_map &lt;- renderLeaflet({\n    req(colombia_map)\n    d &lt;- dept_summary()\n    map_data &lt;- colombia_map |&gt; left_join(d, by = \"Department\")\n    \n    metric &lt;- if(input$map_rate_toggle) \"Rate\" else \"Total\"\n    vals &lt;- map_data[[metric]]\n    pal &lt;- colorNumeric(\"YlOrRd\", domain = vals, na.color = \"#eee\")\n    \n    leaflet(map_data) |&gt;\n      addProviderTiles(providers$CartoDB.Positron) |&gt;\n      addPolygons(\n        fillColor = ~pal(vals), weight = 1, color = \"#666\", fillOpacity = 0.8,\n        label = ~paste0(Department, \": \", comma(round(vals, 1)), if(input$map_rate_toggle) \" per 100k\" else \" cases\"),\n        highlight = highlightOptions(weight = 3, color = \"#333\", bringToFront = TRUE)\n      ) |&gt;\n      addLegend(pal = pal, values = vals, title = if(input$map_rate_toggle) \"Rate / 100k\" else \"Total Cases\")\n  })\n\n  output$department_bar &lt;- renderPlotly({\n    d &lt;- dept_summary() |&gt; arrange(desc(Total)) |&gt; slice_head(n = 15)\n    validate(need(nrow(d) &gt; 0, \"No data\"))\n    \n    p &lt;- ggplot(d, aes(x = Total, y = reorder(Department, Total))) +\n      geom_col(fill = \"#69b3a2\") +\n      geom_text(aes(label = comma(Total)), hjust = -0.1, size = 3) +\n      labs(x = \"Total Cases\", y = NULL) +\n      plot_theme +\n      scale_x_continuous(expand = expansion(mult = c(0, 0.2)))\n    \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  # ---- Distributions (Box Plots) ----\n  output$dept_boxplot &lt;- renderPlotly({\n    d &lt;- filtered_data() |&gt;\n      group_by(Department, Year) |&gt;\n      summarise(Total = sum(Cases, na.rm = TRUE), .groups = \"drop\")\n    \n    validate(need(nrow(d) &gt; 0, \"No data\"))\n    \n    p &lt;- ggplot(d, aes(x = reorder(Department, Total, median), y = Total)) +\n      geom_boxplot(fill = \"#4DB6D0\", alpha = 0.7, outlier.size = 1) +\n      coord_flip() +\n      labs(x = NULL, y = \"Annual Cases\") +\n      plot_theme\n    \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  output$age_sex_boxplot &lt;- renderPlotly({\n    d &lt;- filtered_data() |&gt;\n      group_by(Age, Sex, Year) |&gt;\n      summarise(Cases = sum(Cases, na.rm = TRUE), .groups = \"drop\")\n      \n    validate(need(nrow(d) &gt; 0, \"No data\"))\n\n    p &lt;- ggplot(d, aes(x = factor(Age), y = Cases, fill = Sex)) +\n      geom_boxplot(outlier.size = 0.5) +\n      scale_fill_manual(values = c(\"Men\" = \"#00BFC4\", \"Women\" = \"#F8766D\")) +\n      labs(x = \"Age\", y = \"Annual Cases\") +\n      plot_theme +\n      theme(legend.position = \"none\")\n      \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  # ---- Diagnostics ----\n  output$diagnostic_bar &lt;- renderPlotly({\n    d &lt;- filtered_data() |&gt; group_by(Diagnostic) |&gt; summarise(Total = sum(Cases, na.rm = TRUE)) |&gt; arrange(desc(Total)) |&gt; slice_head(n = 15)\n    validate(need(nrow(d) &gt; 0, \"No data\"))\n    \n    p &lt;- ggplot(d, aes(x = Total, y = reorder(Diagnostic, Total), fill = Total)) +\n      geom_col(show.legend = FALSE) +\n      scale_fill_distiller(palette = \"Blues\", direction = 1) +\n      labs(x = \"Total Cases\", y = NULL) +\n      plot_theme\n    \n    ggplotly(p) |&gt; config(displayModeBar = FALSE)\n  })\n\n  output$diagnostic_table &lt;- renderDT({\n    filtered_data() |&gt;\n      group_by(Diagnostic) |&gt;\n      summarise(Total = sum(Cases, na.rm = TRUE)) |&gt;\n      arrange(desc(Total)) |&gt;\n      mutate(Total = comma(Total)) |&gt;\n      datatable(options = list(pageLength = 10))\n  })\n}\n\nshinyApp(ui, server)",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Interactive App</span>"
    ]
  }
]